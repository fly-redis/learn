<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è¯­æ–‡è¯è¯­å¬å†™åŠ©æ‰‹</title>
    <!-- å¼•å…¥æ‹¼éŸ³åº“ -->
    <script src="https://unpkg.com/pinyin-pro"></script>
    <style>
        :root {
            --primary-color: #007aff; /* iOS Blue */
            --danger-color: #ff3b30;
            --bg-color: #f2f2f7;
            --card-bg: #ffffff;
            --text-primary: #000000;
            --text-secondary: #8e8e93;
            --border-color: #e5e5ea;
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-primary);
            padding-top: 50px; /* Space for header */
            padding-bottom: 90px; /* Space for bottom button */
        }

        /* App é¡¶éƒ¨æ  */
        .app-header {
            position: fixed;
            top: 0; left: 0; right: 0;
            height: 50px;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: 600;
            box-shadow: 0 1px 0 rgba(0,0,0,0.1);
            z-index: 1000;
        }

        .container {
            max-width: 100%;
            padding: 15px;
        }

        /* å¡ç‰‡é€šç”¨æ ·å¼ */
        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        /* è¾“å…¥åŒº */
        .input-row {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
        }
        .input-row input {
            flex: 1;
            padding: 12px;
            border: 1px solid transparent;
            background: #f2f2f7;
            border-radius: 10px;
            font-size: 16px;
            outline: none;
            transition: all 0.3s;
        }
        .input-row input:focus {
            background: #fff;
            border-color: var(--primary-color);
        }

        /* æŒ‰é’®é€šç”¨ */
        .btn {
            border: none;
            padding: 12px;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            text-align: center;
            cursor: pointer;
            background-color: var(--primary-color);
            color: white;
            transition: opacity 0.2s;
        }
        .btn:active { opacity: 0.7; }
        .btn.block { display: block; width: 100%; }
        .btn.secondary { background-color: #f2f2f7; color: var(--primary-color); }
        .btn.danger { background-color: #fff0f0; color: var(--danger-color); }
        
        /* å·¥å…·æ ç½‘æ ¼ */
        .tools-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr); /* æ”¹ä¸º3åˆ—é€‚é…5ä¸ªæŒ‰é’® */
            gap: 8px;
            margin-bottom: 20px;
        }
        .tools-grid .btn {
            font-size: 13px;
            padding: 10px 0;
            background: var(--card-bg);
            color: var(--primary-color);
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .tools-grid .btn.danger { color: var(--danger-color); }

        /* åˆ—è¡¨æ ·å¼ */
        .word-list {
            padding: 0;
            margin: 0;
            list-style: none;
        }
        .word-item {
            background: var(--card-bg);
            padding: 16px;
            margin-bottom: 12px;
            border-radius: 14px;
            display: flex;
            flex-direction: column; /* æ”¹ä¸ºçºµå‘å¸ƒå±€ */
            box-shadow: 0 2px 6px rgba(0,0,0,0.04);
        }

        /* æ–°å¢ï¼šä¸ŠåŠéƒ¨åˆ†å®¹å™¨ */
        .word-item-top {
            display: flex;
            align-items: center;
            width: 100%;
        }
        
        /* è‡ªå®šä¹‰å¤é€‰æ¡† UI */
        .checkbox-wrapper {
            margin-right: 0; /* ç§»é™¤å¤–è¾¹è· */
            /* å¢åŠ ç‚¹å‡»åŒºåŸŸ */
            padding: 2px; /* å‡å°å†…è¾¹è· */
            cursor: pointer;
        }
        
        /* æ–°å¢ï¼šæ–¹å½¢åŒºé—´é€‰æ‹©æ¡† */
        .range-checkbox {
            width: 24px;
            height: 24px;
            border: 2px solid #c7c7cc;
            border-radius: 4px; /* æ–¹å½¢åœ†è§’ */
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            margin-right: 0; /* ç´§æŒ¨ç€ */
        }
        /* æ¿€æ´»çŠ¶æ€ (ä½œä¸ºèµ·ç‚¹) */
        .range-checkbox.active {
            border-color: #FF9500; /* ä½¿ç”¨æ©™è‰²åŒºåˆ† */
            background: #FF9500;
        }
        .range-checkbox.active::after {
            content: 'S'; /* S for Start */
            color: white;
            font-size: 12px;
            font-weight: bold;
        }

        /* åŸæœ‰åœ†å½¢å¤é€‰æ¡† */
        .custom-checkbox {
            width: 24px;
            height: 24px;
            border: 2px solid #c7c7cc;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            margin-left: 2px; /* ç»™ä¸€ç‚¹å¾®å°çš„é—´è· */
        }
        .custom-checkbox.checked {
            background: var(--primary-color);
            border-color: var(--primary-color);
        }
        .custom-checkbox::after {
            content: '';
            width: 5px;
            height: 10px;
            border: solid white;
            border-width: 0 2px 2px 0;
            transform: rotate(45deg);
            display: none;
            margin-top: -2px;
        }
        .custom-checkbox.checked::after { display: block; }

        .word-content { 
            flex: 1; 
            overflow: hidden; 
            display: flex;
            flex-direction: column; /* æ”¹ä¸ºçºµå‘æ’åˆ—ï¼šæ‹¼éŸ³åœ¨ä¸Š */
            justify-content: center;
            align-items: flex-start; /* å·¦å¯¹é½ */
            padding-left: 15px; /* ä¸é€‰æ¡†çš„é—´è· */
            min-width: 0; /* å…³é”®ï¼šå…è®¸Flexå­é¡¹åœ¨å†…å®¹è¿‡é•¿æ—¶æ”¶ç¼©æ¢è¡Œ */
        }
        .word-pinyin { 
            font-size: 17px; 
            
            color: #000; /* é»‘è‰² */
            margin-bottom: 4px; 
            line-height: 1.3;
            word-wrap: break-word; /* é•¿æ‹¼éŸ³æ¢è¡Œ */
        }
        .word-text { 
            font-size: 16px; 
            
            color: #333; 
            margin-bottom: 0; 
            line-height: 1.3;
            word-wrap: break-word; /* é•¿è¯è¯­æ¢è¡Œ */
        }
        /* ä¿®æ”¹ï¼šä¸‹åŠéƒ¨åˆ†æ—¶é—´æ ·å¼ */
        .last-tested { 
            font-size: 13px; 
            color: #888; 
            margin-top: 8px; 
            line-height: 0.4;
            padding-left: 0px; /* ç¼©è¿›ä»¥å¯¹é½æ–‡å­—å†…å®¹ */
        }

        .action-btns {
            display: flex;
            flex-direction: column; /* æŒ‰é’®æ”¹ä¸ºçºµå‘å †å  */
            gap: 8px;
            margin-left: 10px;
            flex-shrink: 0; /* é˜²æ­¢æŒ‰é’®è¢«æŒ¤å‹ */
        }
        .icon-btn {
            padding: 6px 14px;
            border-radius: 6px;
            font-size: 12px;
            background: #f2f2f7;
            color: var(--text-secondary);
        }

        /* åº•éƒ¨å›ºå®šæ  */
        .bottom-bar {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            padding: 15px 20px 30px 20px; /* é€‚é… iPhone X åº•éƒ¨ */
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(0,0,0,0.05);
            z-index: 900;
        }
        .start-btn {
            width: 100%;
            padding: 16px;
            font-size: 18px;
            border-radius: 14px;
            box-shadow: 0 4px 15px rgba(0,122,255,0.3);
        }

        /* å¬å†™é¡µé¢ */
        #dictation-page { padding-top: 60px; display: none; }
        .dictation-card {
            background: #fff;
            border-radius: 16px;
            padding: 40px 20px;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            position: relative;
        }
        
        /* ç”°å­—æ ¼æ ·å¼ */
        .tzg-row {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
        }
        .tzg-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .tzg-pinyin {
            font-size: 20px;
            color: #333;
            margin-bottom: 8px;
            font-family: Arial, sans-serif;
            min-height: 24px;
        }
        .tzg-box {
            width: 64px;
            height: 64px;
            border: 2px solid #333;
            position: relative;
            background: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        /* ç”°å­—æ ¼è™šçº¿ */
        .tzg-box::before {
            content: '';
            position: absolute;
            top: 0; bottom: 0; left: 50%;
            border-left: 1px dashed #bdbdbd;
            transform: translateX(-50%);
        }
        .tzg-box::after {
            content: '';
            position: absolute;
            left: 0; right: 0; top: 50%;
            border-top: 1px dashed #bdbdbd;
            transform: translateY(-50%);
        }
        .tzg-char {
            font-family: "KaiTi", "æ¥·ä½“", "STKaiti", serif;
            font-size: 42px;
            z-index: 2;
            color: var(--primary-color);
            transition: opacity 0.3s;
        }

        /* æ¨¡å¼1: çœ‹æ‹¼éŸ³å†™è¯ (é»˜è®¤) - éšè—æ±‰å­—, æ˜¾ç¤ºæ‹¼éŸ³ */
        .dictation-card.mode-py2wd .tzg-char { opacity: 0; }
        .dictation-card.mode-py2wd.revealed .tzg-char { opacity: 1; }

        /* æ¨¡å¼2: çœ‹è¯å†™æ‹¼éŸ³ - æ˜¾ç¤ºæ±‰å­—, éšè—æ‹¼éŸ³ */
        .dictation-card.mode-wd2py .tzg-char { opacity: 1; }
        .dictation-card.mode-wd2py .tzg-pinyin,
        .dictation-card.mode-wd2py .dictation-pinyin { opacity: 0; transition: opacity 0.3s; }
        .dictation-card.mode-wd2py.revealed .tzg-pinyin,
        .dictation-card.mode-wd2py.revealed .dictation-pinyin { opacity: 1; }

        /* å…¼å®¹æ—§çš„æ‹¼éŸ³æ˜¾ç¤ºï¼ˆå½“æ— æ³•ä¸€ä¸€å¯¹åº”æ—¶ï¼‰ */
        .dictation-pinyin { 
            font-size: 24px; 
            color: #333; 
            margin-bottom: 15px; 
            font-weight: 500;
        }
        .hint { color: #aaa; margin-top: 10px; font-size: 13px; }

        /* å¼¹çª—ä¼˜åŒ– */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            display: flex; /* æ”¹ä¸º flex å¸ƒå±€ï¼Œä½†é»˜è®¤éšè—éœ€ç”¨ JS æ§åˆ¶ */
            align-items: center; /* å‚ç›´å±…ä¸­ */
            justify-content: center; /* æ°´å¹³å±…ä¸­ */
            /* æ³¨æ„ï¼šdisplay:none ä¼šè¦†ç›– flexï¼Œæ‰€ä»¥åœ¨æ ·å¼é‡Œè¿˜è¦å¤„ç† */
        }
        /* è¦†ç›–ä¹‹å‰çš„ display:noneï¼Œä½¿ç”¨å…·ä½“çš„ç±»æ¥æ§åˆ¶æ˜¾ç¤º */
        .modal[style*="display: block"] {
            display: flex !important;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 400px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            /* å»æ‰ä¹‹å‰çš„ marginï¼Œå› ä¸ºç°åœ¨ç”¨ flex å±…ä¸­ */
            margin: 0; 
        }
        
        #io-textarea {
            width: 100%;
            height: 150px;
            border: 1px solid #e0e0e0;
            padding: 12px;
            border-radius: 12px;
            font-family: monospace;
            font-size: 14px;
            resize: none;
            background-color: #f9f9f9;
            margin-bottom: 10px;
            box-sizing: border-box; /* ç¡®ä¿ padding ä¸ä¼šæ’‘ç ´å®½åº¦ */
        }
        
        #io-textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            background-color: #fff;
        }
        
        /* å¼¹çª—æ ‡é¢˜ */
        #modal-title {
            margin: 0 0 15px 0;
            text-align: center;
            font-size: 18px;
            color: #333;
        }

        /* å¼¹çª—æŒ‰é’®ç»„ç½‘æ ¼å¸ƒå±€ */
        .modal-btns {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }

        /* æ–°å¢ï¼šå†å²è®°å½•ç›¸å…³æ ·å¼ */
        .history-record {
            background: #f9f9f9;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            list-style: none;
        }
        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .history-time { font-size: 14px; color: #333; line-height: 1.4; }
        .history-actions { display: flex; gap: 8px; }
        .history-details {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed #ccc;
            display: none; /* é»˜è®¤éšè— */
            flex-wrap: wrap; /* è‡ªåŠ¨æ¢è¡Œ */
            gap: 6px;
        }
        .history-tag {
            background: #e5e5ea;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            color: #333;
        }

        /* æ–°å¢ï¼šæ‚¬æµ®æ§åˆ¶åŒº (ç»Ÿè®¡ + æŒ‰é’®) */
        .float-controls {
            position: fixed;
            bottom: 120px;
            right: 20px;
            display: flex;
            flex-direction: column-reverse; /* æŒ‰é’®åœ¨ä¸‹ï¼Œç»Ÿè®¡åœ¨ä¸Š */
            align-items: flex-end;
            gap: 10px;
            z-index: 950;
            pointer-events: none; /* å®¹å™¨æœ¬èº«ä¸é˜»æŒ¡ç‚¹å‡» */
        }

        .word-stats-pill {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            pointer-events: auto;
            white-space: nowrap;
            transition: all 0.3s;
        }

        /* ä¿®æ”¹ï¼šå›åˆ°é¡¶éƒ¨æŒ‰é’®æ ·å¼ (é€‚é…æ‚¬æµ®å®¹å™¨) */
        #back-to-top {
            /* ç§»é™¤ fixed å®šä½ï¼Œç”±å®¹å™¨æ§åˆ¶ä½ç½® */
            position: static;
            width: 44px;
            height: 44px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(0,0,0,0.1);
            border-radius: 50%;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: none; /* é»˜è®¤éšè— */
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--primary-color);
            font-size: 20px;
            font-weight: bold;
            transition: all 0.3s;
            pointer-events: auto;
        }
        #back-to-top:active { transform: scale(0.9); }

        /* æ–°å¢ï¼šæœç´¢ä¸‹æ‹‰æ¡†æ ·å¼ */
        .search-dropdown {
            position: absolute;
            top: 100%; left: 0; right: 0;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            z-index: 1100;
            max-height: 250px;
            overflow-y: auto;
            list-style: none;
            padding: 0;
            margin: 5px 0 0 0;
            display: none;
            border: 1px solid #e5e5ea;
        }
        .search-result-item {
            padding: 12px 15px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .search-result-item:last-child { border-bottom: none; }
        .search-result-item:active { background: #f2f2f7; }

        /* æœç´¢å®šä½é«˜äº®åŠ¨ç”» */
        .highlight-flash {
            animation: flash-bg 2s ease-out;
            border: 2px solid var(--primary-color) !important; /* å¼ºåˆ¶è¾¹æ¡†é«˜äº® */
        }
        @keyframes flash-bg {
            0% { background-color: #fff9c4; transform: scale(1.02); }
            50% { background-color: #fff9c4; }
            100% { background-color: var(--card-bg); transform: scale(1); }
        }

        /* æ–°å¢ï¼šæ ‡ç­¾ç›¸å…³æ ·å¼ */
        .tag-row {
            margin-top: 10px;
        }
        /* åˆ—è¡¨é¡¹ä¸­çš„æ ‡ç­¾ */
        .item-tags {
            margin-top: 4px;
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }
        .tag-badge {
            font-size: 10px;
            color: #666;
            background: #f0f0f5;
            padding: 2px 6px;
            border-radius: 4px;
        }

        /* æ ‡ç­¾ç­›é€‰æ  */
        .filter-bar {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding: 5px 2px 15px 2px;
            margin-bottom: 5px;
            -webkit-overflow-scrolling: touch; /* iOS é¡ºæ»‘æ»šåŠ¨ */
        }
        .filter-pill {
            padding: 6px 14px;
            background: #fff;
            border: 1px solid #e5e5ea;
            border-radius: 16px;
            font-size: 13px;
            color: #666;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
            box-shadow: 0 1px 2px rgba(0,0,0,0.02);
        }
        .filter-pill.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            box-shadow: 0 4px 10px rgba(0,122,255,0.25);
        }

    </style>
</head>
<body>

<header class="app-header" id="header-title">è¯è¯­æœ¬</header>

<div class="container" id="main-page">
    
    <!-- è¾“å…¥å¡ç‰‡ -->
    <div class="card">
        <div class="input-row">
            <input type="text" id="new-word" placeholder="è¾“å…¥è¯è¯­ (è‡ªåŠ¨ç”Ÿæˆæ‹¼éŸ³)" oninput="autoGeneratePinyin()">
        </div>
        <div class="input-row">
            <input type="text" id="new-pinyin" placeholder="æ‹¼éŸ³">
            <button class="btn secondary" onclick="autoGeneratePinyin()" style="padding: 0 15px; font-size: 14px; white-space: nowrap;">ç”Ÿæˆæ‹¼éŸ³</button>
        </div>
        <!-- æ–°å¢ï¼šæ ‡ç­¾è¾“å…¥ -->
        <div class="input-row tag-row">
             <input type="text" id="new-tags" placeholder="æ ‡ç­¾ (å¦‚æœ‰å¤šä¸ªè¯·ç”¨ç©ºæ ¼åˆ†éš”ï¼Œå¦‚ï¼šç¬¬ä¸€å•å…ƒ é‡ç‚¹)">
        </div>

        <div style="display: flex; gap: 10px; margin-top: 12px;">
            <button class="btn block" style="flex:1" id="submit-btn" onclick="handleWordSubmit()">æ·»åŠ </button>
            <button class="btn secondary" id="cancel-btn" onclick="cancelEdit()" style="display:none; width: 80px;">å–æ¶ˆ</button>
        </div>
    </div>

    <!-- å·¥å…·æ  -->
    <div class="tools-grid">
        <div class="btn" onclick="selectAll()">å…¨é€‰</div>
        <div class="btn" onclick="importJson()">å¯¼å…¥</div>
        <div class="btn" onclick="exportJson()">å¯¼å‡º</div>
        <div class="btn" onclick="sortByTime()">æ—¶é—´æ’åº</div>
        <div class="btn" onclick="showHistory()" style="background-color: #E3F2FD; color: #007aff;">å†å²è®°å½•</div>
        <div class="btn danger" onclick="deleteSelected()">åˆ é™¤é€‰ä¸­</div>
        <div class="btn danger" onclick="clearWords()">æ¸…ç©ºå…¨éƒ¨</div>
    </div>

    <!-- ä¿®æ”¹ï¼šå®æ—¶æœç´¢æ  -->
    <div class="input-row" style="margin-bottom: 10px; position: relative;">
        <input type="search" id="search-input" placeholder="ğŸ” æœç´¢è¯è¯­æˆ–æ‹¼éŸ³..." 
               style="background: #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.05);"
               autocomplete="off"
               oninput="handleSearch(this.value)"
               onfocus="handleSearch(this.value)"
               onblur="setTimeout(() => { document.getElementById('search-results').style.display='none' }, 200)">
        <ul id="search-results" class="search-dropdown"></ul>
    </div>

    <!-- æ–°å¢ï¼šæ ‡ç­¾ç­›é€‰æ  -->
    <div class="filter-bar" id="tag-filter-container">
        <!-- JS ç”Ÿæˆ -->
    </div>

    <ul class="word-list" id="word-list-dom">
        <!-- åˆ—è¡¨ç”±JSç”Ÿæˆ -->
    </ul>

    <div class="bottom-bar">
        <div style="display: flex; gap: 10px;">
            <button class="btn start-btn" style="flex: 1;" onclick="startDictation('py2wd')">
                çœ‹æ‹¼éŸ³å†™è¯
            </button>
            <button class="btn start-btn" style="flex: 1; background-color: #FF9500;" onclick="startDictation('wd2py')">
                çœ‹è¯å†™æ‹¼éŸ³
            </button>
        </div>
    </div>
</div>

<div class="container" id="dictation-page">
    <div style="margin-bottom: 20px; display: flex; gap: 10px;">
        <button class="btn secondary" style="flex:1" onclick="exitDictation()">é€€å‡º</button>
        <button class="btn secondary" style="flex:1" onclick="toggleAllAnswers()">æ˜¾ç¤ºç­”æ¡ˆ</button>
    </div>
    <div id="dictation-area"></div>
</div>

<!-- ä¿®æ”¹ï¼šæµ®åŠ¨æ§åˆ¶ç»„ -->
<div class="float-controls">
    <div id="back-to-top" onclick="scrollToTop()">â†‘</div>
    <div id="word-stats" class="word-stats-pill">ç»Ÿè®¡åŠ è½½ä¸­...</div>
</div>

<!-- æ–°å¢ï¼šå†å²è®°å½•å¼¹çª— -->
<div id="history-modal" class="modal" style="display: none;">
    <div class="modal-content" style="max-height: 80vh; overflow-y: auto;">
        <h3 id="modal-title" style="text-align:center;">å¬å†™è®°å½• (æœ€è¿‘5æ¬¡)</h3>
        <ul id="history-list" style="padding:0; margin:0; list-style:none;">
            <!-- JS ç”Ÿæˆ -->
        </ul>
        <div class="modal-btns">
             <button class="btn secondary" style="grid-column: span 2;" onclick="closeHistoryModal()">å…³é—­</button>
        </div>
    </div>
</div>

<!-- å¯¼å…¥å¯¼å‡ºå¼¹çª— -->
<div id="io-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <h3 id="modal-title">å¯¼å…¥/å¯¼å‡º</h3>
        <textarea id="io-textarea" placeholder="åœ¨æ­¤å¤„ç²˜è´´å†…å®¹..."></textarea>
        <!-- ä¿®æ”¹æŒ‰é’®åŒºåŸŸ -->
        <div class="modal-btns">
            <!-- å¤åˆ¶æŒ‰é’® (å¯¼å‡ºæ—¶æ˜¾ç¤º) -->
            <button class="btn secondary" id="copy-btn" onclick="copyToClipboard()">å¤åˆ¶</button>
            <!-- æ–°å¢ï¼šä¸‹è½½æŒ‰é’® (å¯¼å‡ºæ—¶æ˜¾ç¤º) -->
            <button class="btn secondary" id="download-btn" onclick="downloadJson()" style="display: none; background-color: #007aff; color: white;">ä¸‹è½½æ–‡ä»¶</button>
            <!-- æ–°å¢ï¼šåŒæ­¥æŒ‰é’® (å¯¼å…¥æ—¶æ˜¾ç¤º) -->
            <button class="btn secondary" id="sync-btn" onclick="syncFromGitee()" style="background-color: #34C759; color: white; display: none;">åŒæ­¥github</button>
            <!-- æ¸…ç©ºæŒ‰é’® (å¯¼å…¥æ—¶æ˜¾ç¤º) -->
            <button class="btn danger" id="clear-btn" onclick="clearTextarea()">æ¸…ç©º</button>
            <!-- å…³é—­æŒ‰é’® (å¸¸é©») -->
            <button class="btn secondary" onclick="closeModal()">å…³é—­</button>
            <!-- ç¡®è®¤æŒ‰é’® (å¯¼å…¥æ—¶æ˜¾ç¤º) -->
            <button class="btn" id="modal-action-btn" onclick="confirmImport()">ç¡®è®¤</button>
        </div>
    </div>
</div>

<script>
    // é»˜è®¤æ•°æ®
    let words = [
        { id: 1, text: "æ¸…è„†", pinyin: "qÄ«ng cuÃ¬", checked: true, tags: ["ç¬¬ä¸€å•å…ƒ"] },
        { id: 2, text: "ç³Ÿç³•", pinyin: "zÄo gÄo", checked: true, tags: ["ç¬¬ä¸€å•å…ƒ", "æ˜“é”™"] },
        { id: 3, text: "è´è¶", pinyin: "hÃº diÃ©", checked: false, tags: ["ç¬¬äºŒå•å…ƒ"] }
    ];

    let editingIndex = -1;
    // æ–°å¢ï¼šè®°å½•åŒºé—´é€‰æ‹©çš„èµ·å§‹ç´¢å¼•
    let rangeStartIndex = -1;
    // æ–°å¢ï¼šå½“å‰ç­›é€‰çš„æ ‡ç­¾
    let currentFilterTag = null; 

    window.onload = function() {
        const saved = localStorage.getItem('dictation_words');
        if (saved) { 
            words = JSON.parse(saved); 
            // å…¼å®¹æ—§æ•°æ®ï¼Œç¡®ä¿æœ‰ tags å­—æ®µ
            words.forEach(w => { if(!w.tags) w.tags = []; });
        }
        renderList();
    };

    function save() {
        localStorage.setItem('dictation_words', JSON.stringify(words));
        renderList();
    }

    function renderList() {
        const listDom = document.getElementById('word-list-dom');
        listDom.innerHTML = '';
        
        // 1. æ¸²æŸ“ç­›é€‰æ 
        renderFilterBar();

        let visibleCount = 0;
        
        words.forEach((item, index) => {
            // æ–°å¢ï¼šæ ‡ç­¾ç­›é€‰é€»è¾‘
            if (currentFilterTag && (!item.tags || !item.tags.includes(currentFilterTag))) {
                return; // è¢«ç­›é€‰æ‰ï¼Œä¸æ¸²æŸ“
            }
            visibleCount++;

            const li = document.createElement('li');
            li.className = 'word-item';
            li.id = 'word-item-' + index; // æ–°å¢ï¼šæ·»åŠ IDç”¨äºå®šä½
            
            // ç”Ÿæˆæ ‡ç­¾HTML
            const tagsHtml = (item.tags && item.tags.length > 0) 
                ? `<div class="item-tags">${item.tags.map(t => `<span class="tag-badge">${t}</span>`).join('')}</div>` 
                : '';

            li.innerHTML = `
                <div class="word-item-top">
                    <!-- å·¦ä¾§é€‰æ¡†ç»„ -->
                    <div class="checkbox-wrapper" onclick="toggleRange(${index})" title="ç‚¹å‡»ä¸¤ä¸ªæ–¹æ¡†ä»¥é€‰ä¸­ä¸­é—´æ‰€æœ‰è¯">
                        <div class="range-checkbox ${rangeStartIndex === index ? 'active' : ''}"></div>
                    </div>
                    <div class="checkbox-wrapper" onclick="toggleCheck(${index})">
                        <div class="custom-checkbox ${item.checked ? 'checked' : ''}"></div>
                    </div>
            
                    <!-- ä¸­é—´å†…å®¹ï¼šå…ˆæ‹¼éŸ³åæ±‰å­—ï¼Œå†åŠ æ ‡ç­¾ -->
                    <div class="word-content" onclick="toggleCheck(${index})">
                        <div class="word-pinyin">${item.pinyin}</div>
                        <div class="word-text">${item.text}</div>
                        ${tagsHtml}
                    </div>
            
                    <!-- å³ä¾§æŒ‰é’®ï¼šçºµå‘å †å  -->
                    <div class="action-btns">
                        <div class="icon-btn" onclick="editWord(${index})">ç¼–è¾‘</div>
                        <div class="icon-btn" style="color:var(--danger-color); background:#fff0f0;" onclick="deleteWord(${index})">åˆ é™¤</div>
                    </div>
                </div>
                ${item.lastTested ? `<div class="last-tested">ä¸Šæ¬¡æµ‹è¯•: ${formatDate(item.lastTested)}</div>` : ''}
            `;
            listDom.appendChild(li);
        });

        // æ¢å¤ç»Ÿè®¡æ˜¾ç¤º
        const selectedCount = words.filter(w => w.checked).length;
        const filterInfo = currentFilterTag ? ` (ç­›é€‰: ${currentFilterTag})` : '';
        document.getElementById('word-stats').innerText = `å·²é€‰ ${selectedCount} / å…± ${words.length}${filterInfo}`;
    }

    // æ–°å¢ï¼šæ¸²æŸ“ç­›é€‰æ åŠŸèƒ½
    function renderFilterBar() {
        const container = document.getElementById('tag-filter-container');
        // æ”¶é›†æ‰€æœ‰å»é‡çš„æ ‡ç­¾
        const allTags = new Set();
        words.forEach(w => {
            if (w.tags && Array.isArray(w.tags)) {
                w.tags.forEach(t => allTags.add(t));
            }
        });
        
        // å¦‚æœæ²¡æœ‰æ ‡ç­¾ï¼Œéšè—ç­›é€‰æ 
        if (allTags.size === 0) {
            container.style.display = 'none';
            return;
        }
        container.style.display = 'flex';

        let html = `
            <div class="filter-pill ${currentFilterTag === null ? 'active' : ''}" 
                 onclick="applyFilter(null)">å…¨éƒ¨</div>
        `;
        
        // æ’åºå¹¶ç”Ÿæˆæ ‡ç­¾æŒ‰é’®
        Array.from(allTags).sort().forEach(tag => {
            html += `
                <div class="filter-pill ${currentFilterTag === tag ? 'active' : ''}" 
                     onclick="applyFilter('${tag}')">${tag}</div>
            `;
        });
        
        // åªæœ‰å†…å®¹æ”¹å˜æ—¶æ‰æ›´æ–°HTMLï¼Œé¿å…æ»šåŠ¨ä½ç½®é‡ç½®
        if (container.innerHTML !== html) { 
            // æ³¨æ„ï¼šè¿™æ ·è¿˜æ˜¯ä¼šé‡ç½®æ»šåŠ¨æ¡ï¼Œä¸ºäº†ä½“éªŒå¥½ä¸€ç‚¹ï¼Œå¯ä»¥ç®€ç•¥å¤„ç†
            // è¿™é‡Œç®€å•è¦†ç›–
            container.innerHTML = html;
        }
    }

    function applyFilter(tag) {
        currentFilterTag = tag;
        // åˆ‡æ¢æ ‡ç­¾æ—¶ï¼Œå–æ¶ˆæ­£åœ¨è¿›è¡Œçš„ç¼–è¾‘ï¼ˆé˜²æ­¢ç´¢å¼•æ··ä¹±å¸¦æ¥çš„é—®é¢˜ï¼Œè™½ç„¶ç°åœ¨ç´¢å¼•æ˜¯å®‰å…¨çš„ï¼Œä½†ä¸ºäº†UIä¸€è‡´æ€§ï¼‰
        cancelEdit();
        // é‡ç½®åŒºé—´é€‰æ‹©
        rangeStartIndex = -1;
        renderList();
    }

    // ä¿®æ”¹ï¼šå¤„ç†æœç´¢ (ä¸‹æ‹‰å±•ç¤ºé€»è¾‘)
    function handleSearch(val) {
        const dropdown = document.getElementById('search-results');
        const term = val.trim().toLowerCase();
        
        if (!term) {
            dropdown.style.display = 'none';
            return;
        }

        const matches = words.map((item, index) => ({ item, index }))
            .filter(({ item }) => {
                return item.text.toLowerCase().includes(term) || 
                       (item.pinyin || "").toLowerCase().includes(term);
            });
        
        if (matches.length === 0) {
            dropdown.innerHTML = '<li class="search-result-item" style="color:#999; justify-content:center;">æ— åŒ¹é…ç»“æœ</li>';
        } else {
            dropdown.innerHTML = matches.map(m => `
                <li class="search-result-item" onclick="locateWord(${m.index})">
                    <span style="font-weight:bold; color:#333;">${m.item.text}</span>
                    <span style="font-size:12px; color:#888;">${m.item.pinyin}</span>
                </li>
            `).join('');
        }
        dropdown.style.display = 'block';
    }

    // æ–°å¢ï¼šå®šä½è¯è¯­åŠŸèƒ½
    function locateWord(index) {
        // éšè—æœç´¢ç»“æœ
        document.getElementById('search-results').style.display = 'none';
        
        // å…¼å®¹æ ‡ç­¾ç­›é€‰ï¼šå¦‚æœè¯¥è¯è¢«å½“å‰ç­›é€‰æ¡ä»¶éšè—äº†ï¼Œåˆ™æ¸…é™¤ç­›é€‰
        const targetWord = words[index];
        if (currentFilterTag && (!targetWord.tags || !targetWord.tags.includes(currentFilterTag))) {
            currentFilterTag = null; // æ¸…é™¤ç­›é€‰
            renderList(); // é‡æ–°æ¸²æŸ“æ˜¾ç¤ºå…¨éƒ¨
            // ç¨å¾®å»¶è¿Ÿç­‰å¾…æ¸²æŸ“å®Œæˆ
            setTimeout(() => doLocate(index), 50);
        } else {
            doLocate(index);
        }
    }

    function doLocate(index) {
        const targetLi = document.getElementById('word-item-' + index);
        if (targetLi) {
            targetLi.scrollIntoView({ behavior: 'smooth', block: 'center' });
            targetLi.classList.remove('highlight-flash');
            void targetLi.offsetWidth; // è§¦å‘å›æµ
            targetLi.classList.add('highlight-flash');
        }
    }

    // --- è‡ªåŠ¨ç”Ÿæˆæ‹¼éŸ³ ---
    function autoGeneratePinyin() {
        const wordInput = document.getElementById('new-word').value;
        if(wordInput) {
            const pinyinStr = pinyinPro.pinyin(wordInput);
            document.getElementById('new-pinyin').value = pinyinStr;
        } else {
            document.getElementById('new-pinyin').value = '';
        }
    }

    // --- åŠŸèƒ½åŒº ---
    function handleWordSubmit() {
        const w = document.getElementById('new-word').value.trim();
        const p = document.getElementById('new-pinyin').value.trim();
        // æ–°å¢ï¼šè·å–æ ‡ç­¾
        const tagStr = document.getElementById('new-tags').value.trim();
        // æŒ‰ç©ºæ ¼åˆ†éš”æ ‡ç­¾å¹¶å»ç©º
        const tags = tagStr ? tagStr.split(/\s+/).filter(t => t) : [];
        
        if(!w) return alert('è¯·è¾“å…¥è¯è¯­');

        if (editingIndex === -1) {
            words.push({ 
                id: Date.now(), 
                text: w, 
                pinyin: p || ' ', 
                checked: true,
                tags: tags 
            });
        } else {
            words[editingIndex].text = w;
            words[editingIndex].pinyin = p;
            words[editingIndex].tags = tags;
            cancelEdit();
        }
        
        document.getElementById('new-word').value = '';
        document.getElementById('new-pinyin').value = '';
        document.getElementById('new-tags').value = '';
        save();
    }

    function editWord(index) {
        editingIndex = index;
        const item = words[index];
        document.getElementById('new-word').value = item.text;
        document.getElementById('new-pinyin').value = item.pinyin;
        // æ–°å¢ï¼šå›æ˜¾æ ‡ç­¾
        document.getElementById('new-tags').value = item.tags ? item.tags.join(' ') : '';
        
        document.getElementById('submit-btn').innerText = "ä¿å­˜";
        document.getElementById('cancel-btn').style.display = "inline-block";
        document.getElementById('new-word').focus();
        window.scrollTo(0,0);
    }

    function cancelEdit() {
        editingIndex = -1;
        document.getElementById('new-word').value = '';
        document.getElementById('new-pinyin').value = '';
        document.getElementById('new-tags').value = ''; // æ¸…ç©ºæ ‡ç­¾è¾“å…¥
        document.getElementById('submit-btn').innerText = "æ·»åŠ ";
        document.getElementById('cancel-btn').style.display = "none";
    }

    function deleteWord(index) {
        if(editingIndex === index) {
            return alert("è¯·å…ˆå–æ¶ˆç¼–è¾‘");
        }
        if(confirm('ç¡®å®šåˆ é™¤?')) {
            words.splice(index, 1);
            if(editingIndex > index) editingIndex--; 
            save();
        }
    }

    // --- æ–°å¢: æ‰¹é‡åˆ é™¤åŠŸèƒ½ ---
    function deleteSelected() {
        const count = words.filter(w => w.checked).length;
        if(count === 0) return alert('è¯·å…ˆå‹¾é€‰è¦åˆ é™¤çš„è¯è¯­');
        
        if(confirm(`ç¡®å®šåˆ é™¤é€‰ä¸­çš„ ${count} ä¸ªè¯è¯­å—ï¼Ÿ`)) {
            if(editingIndex !== -1) cancelEdit(); // å¦‚æœæ­£åœ¨ç¼–è¾‘ï¼Œå…ˆé€€å‡ºç¼–è¾‘æ¨¡å¼
            words = words.filter(w => !w.checked);
            rangeStartIndex = -1; // é‡ç½®åŒºé—´é€‰æ‹©
            save();
        }
    }

    function toggleCheck(index) {
        words[index].checked = !words[index].checked;
        save();
    }

    // æ–°å¢ï¼šå¤„ç†åŒºé—´é€‰æ‹©é€»è¾‘
    function toggleRange(index) {
        // å¦‚æœè¿˜æ²¡æœ‰é€‰æ‹©èµ·ç‚¹ï¼Œæˆ–è€…ç‚¹å‡»çš„æ˜¯å½“å‰çš„èµ·ç‚¹ï¼ˆå–æ¶ˆèµ·ç‚¹ï¼‰
        if (rangeStartIndex === -1) {
            rangeStartIndex = index;
            renderList(); // é‡æ–°æ¸²æŸ“ä»¥æ˜¾ç¤ºæ¿€æ´»çŠ¶æ€
        } else if (rangeStartIndex === index) {
            rangeStartIndex = -1; // å–æ¶ˆé€‰æ‹©
            renderList();
        } else {
            // å·²æœ‰èµ·ç‚¹ï¼Œä¸”ç‚¹å‡»äº†ä¸åŒçš„ç‚¹ -> æ‰§è¡Œæ‰¹é‡é€‰ä¸­
            const start = Math.min(rangeStartIndex, index);
            const end = Math.max(rangeStartIndex, index);
            
            // æ£€æŸ¥èŒƒå›´å†…æ˜¯å¦æœ‰æœªé€‰ä¸­çš„
            let hasUnchecked = false;
            for (let i = start; i <= end; i++) {
                if (!words[i].checked) {
                    hasUnchecked = true;
                    break;
                }
            }

            // é€»è¾‘: å¦‚æœèŒƒå›´å†…çš„è¯è¯­æœ‰ä¸€ä¸ªæ²¡æœ‰è¢«é€‰æ‹©(hasUncheckedä¸ºtrue)å°±å…¨éƒ¨é€‰ä¸­(target=true). 
            // å¦åˆ™(è¯´æ˜éƒ½è¢«é€‰ä¸­äº†)å°±æŠŠæ‰€æœ‰è¯è¯­å–æ¶ˆé€‰æ‹©(target=false)
            const targetState = hasUnchecked;

            // åº”ç”¨çŠ¶æ€
            for (let i = start; i <= end; i++) {
                words[i].checked = targetState;
            }
            
            rangeStartIndex = -1; // åŠ¨ä½œå®Œæˆï¼Œé‡ç½®
            save(); // ä¿å­˜å¹¶é‡æ–°æ¸²æŸ“
        }
    }

    function selectAll() {
        const allChecked = words.every(w => w.checked);
        words.forEach(w => w.checked = !allChecked);
        save();
    }
    
    function clearWords() {
        if(confirm('ç¡®å®šæ¸…ç©ºæ‰€æœ‰è¯è¯­å—ï¼Ÿ')) {
            words = [];
            save();
        }
    }

    // æ–°å¢ï¼šæŒ‰æ—¶é—´æ’åºåŠŸèƒ½
    let sortAsc = true; // æ’åºçŠ¶æ€æ ‡è®°
    function sortByTime() {
        // æ’åºä¼šæ‰“ä¹±ç´¢å¼•ï¼Œå› æ­¤å…ˆå–æ¶ˆç¼–è¾‘å’ŒåŒºé—´é€‰æ‹©
        if(editingIndex !== -1) cancelEdit();
        rangeStartIndex = -1;

        words.sort((a, b) => {
            const t1 = a.lastTested || 0;
            const t2 = b.lastTested || 0;
            // å‡åºï¼šæœªæµ‹è¯•(0)åœ¨å‰ï¼›é™åºï¼šæœ€è¿‘æµ‹è¯•(å¤§æ—¶é—´æˆ³)åœ¨å‰
            return sortAsc ? (t1 - t2) : (t2 - t1);
        });
        
        sortAsc = !sortAsc; // åˆ‡æ¢ä¸‹æ¬¡æ’åºé¡ºåº
        save(); // ä¿å­˜é¡ºåºå¹¶é‡æ–°æ¸²æŸ“
    }

    // --- æ–°å¢: å¤åˆ¶æ–‡æœ¬ ---
    function copyToClipboard() {
        const textarea = document.getElementById('io-textarea');
        textarea.select();
        textarea.setSelectionRange(0, 99999); // é€‚é…ç§»åŠ¨ç«¯
        
        // å°è¯•ä½¿ç”¨ Clipboard APIï¼Œå¦‚æœä¸æ”¯æŒåˆ™å›é€€
        if (navigator.clipboard && window.isSecureContext) {
            navigator.clipboard.writeText(textarea.value).then(() => {
                alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            }).catch(() => {
                document.execCommand('copy'); // å›é€€æ–¹æ¡ˆ
                alert('å·²å¤åˆ¶');
            });
        } else {
            document.execCommand('copy'); // å›é€€æ–¹æ¡ˆ
            alert('å·²å¤åˆ¶');
        }
    }

    // --- æ–°å¢: æ¸…ç©ºæ–‡æœ¬ ---
    function clearTextarea() {
        const textarea = document.getElementById('io-textarea');
        textarea.value = '';
        textarea.focus();
    }

    // æ–°å¢ï¼šä¸‹è½½ JSON æ–‡ä»¶
    function downloadJson() {
        const content = document.getElementById('io-textarea').value;
        if (!content) return;

        const d = new Date();
        const dateStr = `${d.getFullYear()}-${(d.getMonth()+1).toString().padStart(2,'0')}-${d.getDate().toString().padStart(2,'0')}`;
        const fileName = `${dateStr}-è¯è¯­.json`;

        const blob = new Blob([content], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    // æ–°å¢ï¼šä» github åŒæ­¥ JSON
    function syncFromGitee() {
        const url = 'https://fly-redis.github.io/learn/%E4%B8%89%E5%B9%B4%E7%BA%A7%E4%B8%8A%E5%AD%A6%E6%9C%9F%E8%AF%8D%E8%AF%AD.json';
        const textarea = document.getElementById('io-textarea');
        
        textarea.value = 'æ­£åœ¨ä» github è·å–æ•°æ®...';
        
        fetch(url)
            .then(response => {
                if (!response.ok) throw new Error('ç½‘ç»œè¯·æ±‚å¤±è´¥');
                return response.text();
            })
            .then(text => {
                textarea.value = text;
                alert('è·å–æˆåŠŸï¼è¯·æ£€æŸ¥å†…å®¹å¹¶ç‚¹å‡»"ç¡®è®¤"å®Œæˆå¯¼å…¥ã€‚');
            })
            .catch(err => {
                textarea.value = '';
                alert('åŒæ­¥å¤±è´¥: ' + err.message);
            });
    }

    function openModal(title, content, isImport) {
        const modal = document.getElementById('io-modal');
        modal.style.display = 'flex'; 
        document.getElementById('modal-title').innerText = title;
        document.getElementById('io-textarea').value = content;
        
        // è·å–æŒ‰é’®DOM
        const actionBtn = document.getElementById('modal-action-btn');
        const copyBtn = document.getElementById('copy-btn');
        const downloadBtn = document.getElementById('download-btn'); // æ–°å¢
        const clearBtn = document.getElementById('clear-btn');
        const syncBtn = document.getElementById('sync-btn'); // æ–°å¢
        const textarea = document.getElementById('io-textarea');

        if(isImport) {
            // å¯¼å…¥æ¨¡å¼: æ˜¾ç¤ºç¡®è®¤ã€æ¸…ç©ºã€åŒæ­¥ï¼›éšè—å¤åˆ¶
            actionBtn.style.display = 'block';
            clearBtn.style.display = 'block';
            syncBtn.style.display = 'block'; // æ˜¾ç¤ºåŒæ­¥æŒ‰é’®
            copyBtn.style.display = 'none';
            downloadBtn.style.display = 'none'; // éšè—ä¸‹è½½
            textarea.readOnly = false;
        } else {
            // å¯¼å‡ºæ¨¡å¼: æ˜¾ç¤ºå¤åˆ¶ï¼›éšè—ç¡®è®¤ã€æ¸…ç©ºã€åŒæ­¥
            actionBtn.style.display = 'none';
            clearBtn.style.display = 'none';
            syncBtn.style.display = 'none'; // éšè—åŒæ­¥æŒ‰é’®
            copyBtn.style.display = 'block';
            downloadBtn.style.display = 'block'; // æ˜¾ç¤ºä¸‹è½½
            textarea.readOnly = true;
            textarea.select();
        }
    }
    
    function closeModal() { document.getElementById('io-modal').style.display = 'none'; }
    
    function exportJson() {
        // ä¿®æ”¹ï¼šå¯¼å‡ºæ—¶åŒ…å« lastTested å’Œ tags å­—æ®µ
        const exportData = words.map(w => ({ 
            word: w.text, 
            pinyin: w.pinyin, 
            lastTested: w.lastTested,
            tags: w.tags // å¯¼å‡ºæ ‡ç­¾
        }));
        openModal('å¯¼å‡ºå†…å®¹', JSON.stringify(exportData, null, 2), false);
    }
    
    function importJson() { openModal('ç²˜è´´JSON', '', true); }

    function confirmImport() {
        try {
            const raw = document.getElementById('io-textarea').value;
            const data = JSON.parse(raw);
            if(!Array.isArray(data)) throw new Error();
            const newWords = data.map(i => ({
                id: Date.now() + Math.random(),
                text: i.word || i.text,
                pinyin: i.pinyin || '',
                checked: true,
                lastTested: i.lastTested || null,
                tags: i.tags || [] // å¯¼å…¥æ ‡ç­¾
            })).filter(i => i.text);
            
            if(confirm('è¦†ç›–å½“å‰åˆ—è¡¨? å–æ¶ˆåˆ™è¿½åŠ ã€‚')) words = newWords;
            else words = words.concat(newWords);
            
            save();
            closeModal();
        } catch(e) { alert('JSONæ ¼å¼é”™è¯¯'); }
    }
    
    // æ–°å¢ï¼šæ ¼å¼åŒ–æ—¶é—´æˆ³
    function formatDate(timestamp) {
        if (!timestamp) return '';
        const d = new Date(timestamp);
        const y = d.getFullYear();
        const m = (d.getMonth() + 1);
        const day = d.getDate();
        const h = d.getHours().toString().padStart(2, '0');
        const min = d.getMinutes().toString().padStart(2, '0');
        const s = d.getSeconds().toString().padStart(2, '0');
        return `${y}å¹´${m}æœˆ${day}æ—¥ ${h}:${min}:${s}`;
    }


    // --- å¬å†™åŠŸèƒ½ ---
    function startDictation(mode) {
        // é»˜è®¤æ¨¡å¼ä¸º çœ‹æ‹¼éŸ³å†™è¯
        const currentMode = mode || 'py2wd';
        
        const selected = words.filter(w => w.checked);
        if(selected.length === 0) return alert('è¯·å…ˆå‹¾é€‰');

        // æ–°å¢ï¼šä¿å­˜åˆ°å†å²è®°å½•
        addToHistory(selected);

        // æ–°å¢ï¼šæ›´æ–°é€‰ä¸­è¯è¯­çš„æµ‹è¯•æ—¶é—´
        const now = Date.now();
        words.forEach(w => {
            if (w.checked) {
                w.lastTested = now;
            }
        });
        save();
        renderList(); // é‡æ–°æ¸²æŸ“åˆ—è¡¨ä»¥æ›´æ–°æ—¶é—´æ˜¾ç¤º

        const container = document.getElementById('dictation-area');
        container.innerHTML = '';
        
        // è®¾ç½®æ ‡é¢˜
        document.getElementById('header-title').innerText = currentMode === 'wd2py' ? "å¬å†™: çœ‹è¯å†™æ‹¼éŸ³" : "å¬å†™: çœ‹æ‹¼éŸ³å†™è¯";
        
        const shuffled = [...selected].sort(() => Math.random() - 0.5);

        shuffled.forEach(item => {
            const card = document.createElement('div');
            // æ·»åŠ æ¨¡å¼ç±»å
            card.className = `dictation-card mode-${currentMode}`;
            card.onclick = function() { this.classList.toggle('revealed'); };
            
            // å°è¯•åˆ†å‰²æ‹¼éŸ³å’Œæ±‰å­—ä»¥è¿›è¡Œå¯¹é½
            const chars = item.text.split('');
            const pinyinArr = item.pinyin ? item.pinyin.trim().split(/\s+/) : [];
            const isAligned = chars.length === pinyinArr.length;

            let contentHtml = '';
            
            // å¦‚æœæ— æ³•å¯¹é½ï¼ˆæ•°é‡ä¸ä¸€è‡´ï¼‰ï¼Œåˆ™åœ¨é¡¶éƒ¨æ˜¾ç¤ºå®Œæ•´æ‹¼éŸ³
            if(!isAligned && item.pinyin) {
                contentHtml += `<div class="dictation-pinyin">${item.pinyin}</div>`;
            }

            contentHtml += '<div class="tzg-row">';
            chars.forEach((char, i) => {
                const py = isAligned ? pinyinArr[i] : '';
                contentHtml += `
                    <div class="tzg-item">
                        ${isAligned ? `<div class="tzg-pinyin">${py}</div>` : ''}
                        <div class="tzg-box">
                            <div class="tzg-char">${char}</div>
                        </div>
                    </div>
                `;
            });
            contentHtml += '</div>';

            card.innerHTML = `
                ${contentHtml}
                <div class="hint">ç‚¹å‡»æ˜¾ç¤ºç­”æ¡ˆ</div>
            `;
            container.appendChild(card);
        });

        document.getElementById('main-page').style.display = 'none';
        document.getElementById('dictation-page').style.display = 'block';
        window.scrollTo(0,0);
    }

    function exitDictation() {
        document.getElementById('dictation-page').style.display = 'none';
        document.getElementById('main-page').style.display = 'block';
        document.getElementById('header-title').innerText = "è¯è¯­æœ¬";
    }

    function toggleAllAnswers() {
        const cards = document.querySelectorAll('.dictation-card');
        const anyHidden = Array.from(cards).some(c => !c.classList.contains('revealed'));
        cards.forEach(c => {
            if(anyHidden) c.classList.add('revealed');
            else c.classList.remove('revealed');
        });
    }

    // --- æ–°å¢ï¼šå†å²è®°å½•ç›¸å…³é€»è¾‘ ---
    
    function addToHistory(selectedWords) {
        let history = JSON.parse(localStorage.getItem('dictation_history') || '[]');
        const record = {
            timestamp: Date.now(),
            wordTexts: selectedWords.map(w => w.text) // åªå­˜æ–‡æœ¬ï¼Œæ–¹ä¾¿æ£€ç´¢
        };
        // åŠ åˆ°æœ€å‰é¢
        history.unshift(record);
        // åªä¿ç•™æœ€è¿‘5æ¡
        if (history.length > 5) {
            history = history.slice(0, 5);
        }
        localStorage.setItem('dictation_history', JSON.stringify(history));
    }

    function showHistory() {
        const history = JSON.parse(localStorage.getItem('dictation_history') || '[]');
        const listDom = document.getElementById('history-list');
        listDom.innerHTML = '';
        
        if (history.length === 0) {
            listDom.innerHTML = '<div style="text-align:center; color:#999; padding:20px;">æš‚æ— å†å²è®°å½•</div>';
        } else {
            history.forEach((rec, idx) => {
                const li = document.createElement('li');
                li.className = 'history-record';
                li.innerHTML = `
                    <div class="history-header">
                        <div class="history-time">
                            ${formatDate(rec.timestamp)}
                            <br><span style="font-size:12px;color:#999">è¯æ•°: ${rec.wordTexts.length}</span>
                        </div>
                        <div class="history-actions">
                            <button class="icon-btn" onclick="toggleHistoryDetail(this)">è¯¦æƒ…</button>
                            <button class="icon-btn" style="background:#e3f2fd; color:#007aff;" onclick="restoreHistory(${idx})">é‡æµ‹</button>
                        </div>
                    </div>
                    <div class="history-details">
                        ${rec.wordTexts.map(t => `<span class="history-tag">${t}</span>`).join('')}
                    </div>
                `;
                listDom.appendChild(li);
            });
        }
        document.getElementById('history-modal').style.display = 'flex';
    }

    function closeHistoryModal() {
        document.getElementById('history-modal').style.display = 'none';
    }

    function toggleHistoryDetail(btn) {
        const details = btn.parentElement.parentElement.nextElementSibling;
        if (details.style.display === 'flex') {
            details.style.display = 'none';
            btn.innerText = 'è¯¦æƒ…';
        } else {
            details.style.display = 'flex';
            btn.innerText = 'æ”¶èµ·';
        }
    }

    function restoreHistory(idx) {
        const history = JSON.parse(localStorage.getItem('dictation_history') || '[]');
        const rec = history[idx];
        if (!rec) return;
        
        // 1. æ¸…ç©ºå½“å‰æ‰€æœ‰é€‰æ‹©
        words.forEach(w => w.checked = false);
        
        const missing = [];
        let count = 0;
        
        // 2. éå†è®°å½•ä¸­çš„è¯ï¼Œåœ¨ç°æœ‰åˆ—è¡¨ä¸­æŸ¥æ‰¾å¹¶é€‰ä¸­
        rec.wordTexts.forEach(txt => {
            const found = words.find(w => w.text === txt);
            if (found) {
                found.checked = true;
                count++;
            } else {
                missing.push(txt);
            }
        });
        
        // 3. ä¿å­˜çŠ¶æ€å¹¶æ›´æ–°ç•Œé¢
        save();     // ä¿å­˜é€‰ä¸­çŠ¶æ€
        renderList(); // é‡ç»˜ä¸»åˆ—è¡¨
        closeHistoryModal(); // å…³é—­å¼¹çª—
        
        // 4. æç¤ºç»“æœ
        let msg = `å·²é€‰ä¸­å†å²è®°å½•ä¸­çš„ ${count} ä¸ªè¯è¯­ã€‚`;
        if (missing.length > 0) {
            msg += `\n\næ³¨æ„ï¼šä»¥ä¸‹ ${missing.length} ä¸ªè¯è¯­åœ¨å½“å‰åˆ—è¡¨ä¸­æœªæ‰¾åˆ°ï¼ˆå¯èƒ½å·²è¢«åˆ é™¤ï¼‰ï¼š\n${missing.join(', ')}`;
        }
        alert(msg);
    }

    function exitDictation() {
        document.getElementById('dictation-page').style.display = 'none';
        document.getElementById('main-page').style.display = 'block';
        document.getElementById('header-title').innerText = "è¯è¯­æœ¬";
    }

    // --- æ–°å¢ï¼šæ»šåŠ¨å›é¡¶éƒ¨é€»è¾‘ ---
    window.onscroll = function() {
        const btn = document.getElementById('back-to-top');
        // æ»šåŠ¨è¶…è¿‡300pxæ˜¾ç¤ºæŒ‰é’®
        if (document.body.scrollTop > 300 || document.documentElement.scrollTop > 300) {
            btn.style.display = 'flex';
        } else {
            btn.style.display = 'none';
        }
    };

    function scrollToTop() {
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
</script>

</body>
</html>
