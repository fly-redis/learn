<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è‹±è¯­å•è¯å¬å†™åŠ©æ‰‹</title>
    <style>
        :root {
            --primary-color: #007aff; /* iOS Blue */
            --danger-color: #ff3b30;
            --bg-color: #f2f2f7;
            --card-bg: #ffffff;
            --text-primary: #000000;
            --text-secondary: #8e8e93;
            --border-color: #e5e5ea;
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-primary);
            padding-top: 50px; /* Space for header */
            padding-bottom: 90px; /* Space for bottom button */
        }

        /* App é¡¶éƒ¨æ  */
        .app-header {
            position: fixed;
            top: 0; left: 0; right: 0;
            height: 50px;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: 600;
            box-shadow: 0 1px 0 rgba(0,0,0,0.1);
            z-index: 1000;
        }

        .container {
            max-width: 100%;
            padding: 15px;
        }

        /* å¡ç‰‡é€šç”¨æ ·å¼ */
        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        /* è¾“å…¥åŒº */
        .input-row {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
        }
        .input-row input {
            flex: 1;
            padding: 12px;
            border: 1px solid transparent;
            background: #f2f2f7;
            border-radius: 10px;
            font-size: 16px;
            outline: none;
            transition: all 0.3s;
        }
        .input-row input:focus {
            background: #fff;
            border-color: var(--primary-color);
        }

        /* æŒ‰é’®é€šç”¨ */
        .btn {
            border: none;
            padding: 12px;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            text-align: center;
            cursor: pointer;
            background-color: var(--primary-color);
            color: white;
            transition: opacity 0.2s;
        }
        .btn:active { opacity: 0.7; }
        .btn.block { display: block; width: 100%; }
        .btn.secondary { background-color: #f2f2f7; color: var(--primary-color); }
        .btn.danger { background-color: #fff0f0; color: var(--danger-color); }
        
        /* å·¥å…·æ ç½‘æ ¼ */
        .tools-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr); /* æ”¹ä¸º3åˆ—é€‚é…5ä¸ªæŒ‰é’® */
            gap: 8px;
            margin-bottom: 20px;
        }
        .tools-grid .btn {
            font-size: 13px;
            padding: 10px 0;
            background: var(--card-bg);
            color: var(--primary-color);
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .tools-grid .btn.danger { color: var(--danger-color); }

        /* åˆ—è¡¨æ ·å¼ */
        .word-list {
            padding: 0;
            margin: 0;
            list-style: none;
        }
        .word-item {
            background: var(--card-bg);
            padding: 16px;
            margin-bottom: 12px;
            border-radius: 14px;
            display: flex;
            flex-direction: column; /* æ”¹ä¸ºçºµå‘å¸ƒå±€ */
            box-shadow: 0 2px 6px rgba(0,0,0,0.04);
        }

        /* æ–°å¢ï¼šä¸ŠåŠéƒ¨åˆ†å®¹å™¨ */
        .word-item-top {
            display: flex;
            align-items: center;
            width: 100%;
        }
        
        /* è‡ªå®šä¹‰å¤é€‰æ¡† UI */
        .checkbox-wrapper {
            margin-right: 0; /* ç§»é™¤å¤–è¾¹è· */
            /* å¢åŠ ç‚¹å‡»åŒºåŸŸ */
            padding: 2px; /* å‡å°å†…è¾¹è· */
            cursor: pointer;
        }
        
        /* æ–°å¢ï¼šæ–¹å½¢åŒºé—´é€‰æ‹©æ¡† */
        .range-checkbox {
            width: 24px;
            height: 24px;
            border: 2px solid #c7c7cc;
            border-radius: 4px; /* æ–¹å½¢åœ†è§’ */
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            margin-right: 0; /* ç´§æŒ¨ç€ */
        }
        /* æ¿€æ´»çŠ¶æ€ (ä½œä¸ºèµ·ç‚¹) */
        .range-checkbox.active {
            border-color: #FF9500; /* ä½¿ç”¨æ©™è‰²åŒºåˆ† */
            background: #FF9500;
        }
        .range-checkbox.active::after {
            content: 'S'; /* S for Start */
            color: white;
            font-size: 12px;
            font-weight: bold;
        }

        /* åŸæœ‰åœ†å½¢å¤é€‰æ¡† */
        .custom-checkbox {
            width: 24px;
            height: 24px;
            border: 2px solid #c7c7cc;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            margin-left: 2px; /* ç»™ä¸€ç‚¹å¾®å°çš„é—´è· */
        }
        .custom-checkbox.checked {
            background: var(--primary-color);
            border-color: var(--primary-color);
        }
        .custom-checkbox::after {
            content: '';
            width: 5px;
            height: 10px;
            border: solid white;
            border-width: 0 2px 2px 0;
            transform: rotate(45deg);
            display: none;
            margin-top: -2px;
        }
        .custom-checkbox.checked::after { display: block; }

        .word-content { 
            flex: 1; 
            overflow: hidden; 
            display: flex;
            flex-direction: column; /* æ”¹ä¸ºçºµå‘æ’åˆ—ï¼šæ‹¼éŸ³åœ¨ä¸Š */
            justify-content: center;
            align-items: flex-start; /* å·¦å¯¹é½ */
            padding-left: 15px; /* ä¸é€‰æ¡†çš„é—´è· */
            min-width: 0; /* å…³é”®ï¼šå…è®¸Flexå­é¡¹åœ¨å†…å®¹è¿‡é•¿æ—¶æ”¶ç¼©æ¢è¡Œ */
        }
        .word-pinyin { 
            font-size: 17px; 
            
            color: #000; /* é»‘è‰² */
            margin-bottom: 4px; 
            line-height: 1.3;
            word-wrap: break-word; /* é•¿æ‹¼éŸ³æ¢è¡Œ */
        }
        .word-text { 
            font-size: 16px; 
            
            color: #333; 
            margin-bottom: 0; 
            line-height: 1.3;
            word-wrap: break-word; /* é•¿è¯è¯­æ¢è¡Œ */
        }
        /* ä¿®æ”¹ï¼šä¸‹åŠéƒ¨åˆ†æ—¶é—´æ ·å¼ */
        .last-tested { 
            font-size: 13px; 
            color: #888; 
            margin-top: 8px; 
            line-height: 0.4;
            padding-left: 0px; /* ç¼©è¿›ä»¥å¯¹é½æ–‡å­—å†…å®¹ */
        }

        .action-btns {
            display: flex;
            flex-direction: column; /* æŒ‰é’®æ”¹ä¸ºçºµå‘å †å  */
            gap: 8px;
            margin-left: 10px;
            flex-shrink: 0; /* é˜²æ­¢æŒ‰é’®è¢«æŒ¤å‹ */
        }
        .icon-btn {
            padding: 6px 14px;
            border-radius: 6px;
            font-size: 12px;
            background: #f2f2f7;
            color: var(--text-secondary);
        }

        /* åº•éƒ¨å›ºå®šæ  */
        .bottom-bar {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            padding: 15px 20px 30px 20px; /* é€‚é… iPhone X åº•éƒ¨ */
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(0,0,0,0.05);
            z-index: 900;
        }
        .start-btn {
            width: 100%;
            padding: 16px;
            font-size: 18px;
            border-radius: 14px;
            box-shadow: 0 4px 15px rgba(0,122,255,0.3);
        }

        /* è½å¯«é é¢ */
        #dictation-page { padding-top: 60px; display: none; }
        .dictation-card {
            background: #fff;
            border-radius: 16px;
            padding: 30px 20px;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            position: relative;
            cursor: pointer;
        }

        /* å•è¯å¬å†™ç›¸å…³æ ·å¼ - æ›¿ä»£åŸç”°å­—æ ¼ */
        .q-text {
            font-size: 24px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            line-height: 1.4;
        }
        
        .a-text {
            font-size: 26px;
            font-weight: bold;
            color: var(--primary-color);
            margin-top: 15px;
            opacity: 0; /* é»˜è®¤éšè—ç­”æ¡ˆ */
            transition: opacity 0.3s;
            font-family: Georgia, 'Times New Roman', Times, serif; /* è‹±æ–‡è¡¬çº¿ä½“æ›´å¥½çœ‹ */
        }
        
        .dictation-card.revealed .a-text { opacity: 1; }

        .hint { color: #aaa; margin-top: 15px; font-size: 13px; }

        /* å¼¹çª—ä¼˜åŒ– */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            display: flex; /* æ”¹ä¸º flex å¸ƒå±€ï¼Œä½†é»˜è®¤éšè—éœ€ç”¨ JS æ§åˆ¶ */
            align-items: center; /* å‚ç›´å±…ä¸­ */
            justify-content: center; /* æ°´å¹³å±…ä¸­ */
            /* æ³¨æ„ï¼šdisplay:none ä¼šè¦†ç›– flexï¼Œæ‰€ä»¥åœ¨æ ·å¼é‡Œè¿˜è¦å¤„ç† */
        }
        /* è¦†ç›–ä¹‹å‰çš„ display:noneï¼Œä½¿ç”¨å…·ä½“çš„ç±»æ¥æ§åˆ¶æ˜¾ç¤º */
        .modal[style*="display: block"] {
            display: flex !important;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 400px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            /* å»æ‰ä¹‹å‰çš„ marginï¼Œå› ä¸ºç°åœ¨ç”¨ flex å±…ä¸­ */
            margin: 0; 
        }
        
        #io-textarea {
            width: 100%;
            height: 150px;
            border: 1px solid #e0e0e0;
            padding: 12px;
            border-radius: 12px;
            font-family: monospace;
            font-size: 14px;
            resize: none;
            background-color: #f9f9f9;
            margin-bottom: 10px;
            box-sizing: border-box; /* ç¡®ä¿ padding ä¸ä¼šæ’‘ç ´å®½åº¦ */
        }
        
        #io-textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            background-color: #fff;
        }
        
        /* å¼¹çª—æ ‡é¢˜ */
        #modal-title {
            margin: 0 0 15px 0;
            text-align: center;
            font-size: 18px;
            color: #333;
        }

        /* å¼¹çª—æŒ‰é’®ç»„ç½‘æ ¼å¸ƒå±€ */
        .modal-btns {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }

        /* æ–°å¢ï¼šå†å²è®°å½•ç›¸å…³æ ·å¼ */
        .history-record {
            background: #f9f9f9;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            list-style: none;
        }
        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .history-time { font-size: 14px; color: #333; line-height: 1.4; }
        .history-actions { display: flex; gap: 8px; }
        .history-details {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed #ccc;
            display: none; /* é»˜è®¤éšè— */
            flex-wrap: wrap; /* è‡ªåŠ¨æ¢è¡Œ */
            gap: 6px;
        }
        .history-tag {
            background: #e5e5ea;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            color: #333;
        }

        /* æ–°å¢ï¼šæ‚¬æµ®æ§åˆ¶åŒº (ç»Ÿè®¡ + æŒ‰é’®) */
        .float-controls {
            position: fixed;
            bottom: 120px;
            right: 20px;
            display: flex;
            flex-direction: column-reverse; /* æŒ‰é’®åœ¨ä¸‹ï¼Œç»Ÿè®¡åœ¨ä¸Š */
            align-items: flex-end;
            gap: 10px;
            z-index: 950;
            pointer-events: none; /* å®¹å™¨æœ¬èº«ä¸é˜»æŒ¡ç‚¹å‡» */
        }

        .word-stats-pill {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            pointer-events: auto;
            white-space: nowrap;
            transition: all 0.3s;
        }

        /* ä¿®æ”¹ï¼šå›åˆ°é¡¶éƒ¨æŒ‰é’®æ ·å¼ (é€‚é…æ‚¬æµ®å®¹å™¨) */
        #back-to-top {
            /* ç§»é™¤ fixed å®šä½ï¼Œç”±å®¹å™¨æ§åˆ¶ä½ç½® */
            position: static;
            width: 44px;
            height: 44px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(0,0,0,0.1);
            border-radius: 50%;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: none; /* é»˜è®¤éšè— */
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--primary-color);
            font-size: 20px;
            font-weight: bold;
            transition: all 0.3s;
            pointer-events: auto;
        }
        #back-to-top:active { transform: scale(0.9); }

    </style>
</head>
<body>

<header class="app-header" id="header-title">è‹±è¯­å•è¯æœ¬</header>

<div class="container" id="main-page">
    
    <!-- è¾“å…¥å¡ç‰‡ -->
    <div class="card">
        <div class="input-row">
            <input type="text" id="new-word" placeholder="è¾“å…¥è‹±è¯­å•è¯">
        </div>
        <div class="input-row">
            <input type="text" id="new-pinyin" placeholder="ä¸­æ–‡æ„æ€">
            <!-- æ–°å¢ï¼šç¿»è¯‘æŒ‰é’® -->
            <button class="btn secondary" onclick="autoTranslate()" style="padding: 0 15px; font-size: 14px; white-space: nowrap;">ç¿»è¯‘</button>
        </div>
        <div style="display: flex; gap: 10px;">
            <button class="btn block" style="flex:1" id="submit-btn" onclick="handleWordSubmit()">æ·»åŠ </button>
            <button class="btn secondary" id="cancel-btn" onclick="cancelEdit()" style="display:none; width: 80px;">å–æ¶ˆ</button>
        </div>
    </div>

    <!-- å·¥å…·æ  -->
    <div class="tools-grid">
        <div class="btn" onclick="selectAll()">å…¨é€‰</div>
        <div class="btn" onclick="importJson()">å¯¼å…¥</div>
        <div class="btn" onclick="exportJson()">å¯¼å‡º</div>
        <div class="btn" onclick="sortByTime()">æ—¶é—´æ’åº</div>
        <div class="btn" onclick="showHistory()" style="background-color: #E3F2FD; color: #007aff;">å†å²è®°å½•</div>
        <!-- æ–°å¢ï¼šç¼“å­˜éŸ³é¢‘æŒ‰é’® -->
        <div class="btn" onclick="cacheAllAudio()" style="background-color: #34C759; color: white;">ç¼“å­˜éŸ³é¢‘</div>
        <div class="btn danger" onclick="deleteSelected()">åˆ é™¤é€‰ä¸­</div>
        <div class="btn danger" onclick="clearWords()">æ¸…ç©ºå…¨éƒ¨</div>
    </div>

    <ul class="word-list" id="word-list-dom">
        <!-- åˆ—è¡¨ç”±JSç”Ÿæˆ -->
    </ul>

    <div class="bottom-bar">
        <div style="display: flex; gap: 10px;">
            <button class="btn start-btn" style="flex: 1;" onclick="startDictation('dictation')">
                å•è¯é»˜å†™
            </button>
            <button class="btn start-btn" style="flex: 1; background-color: #FF9500;" onclick="startDictation('show_english')">
                è‹±æ–‡å±•ç¤º
            </button>
        </div>
    </div>
</div>

<div class="container" id="dictation-page">
    <div style="margin-bottom: 20px; display: flex; gap: 10px;">
        <button class="btn secondary" style="flex:1" onclick="exitDictation()">é€€å‡º</button>
        <button class="btn secondary" style="flex:1" onclick="toggleAllAnswers()">æ˜¾ç¤ºç­”æ¡ˆ</button>
    </div>
    <div id="dictation-area"></div>
</div>

<!-- ä¿®æ”¹ï¼šæµ®åŠ¨æ§åˆ¶ç»„ -->
<div class="float-controls">
    <div id="back-to-top" onclick="scrollToTop()">â†‘</div>
    <div id="word-stats" class="word-stats-pill">ç»Ÿè®¡åŠ è½½ä¸­...</div>
</div>

<!-- æ–°å¢ï¼šå†å²è®°å½•å¼¹çª— -->
<div id="history-modal" class="modal" style="display: none;">
    <div class="modal-content" style="max-height: 80vh; overflow-y: auto;">
        <h3 id="modal-title" style="text-align:center;">å¬å†™è®°å½• (æœ€è¿‘5æ¬¡)</h3>
        <ul id="history-list" style="padding:0; margin:0; list-style:none;">
            <!-- JS ç”Ÿæˆ -->
        </ul>
        <div class="modal-btns">
             <button class="btn secondary" style="grid-column: span 2;" onclick="closeHistoryModal()">å…³é—­</button>
        </div>
    </div>
</div>

<!-- å¯¼å…¥å¯¼å‡ºå¼¹çª— -->
<div id="io-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <h3 id="modal-title">å¯¼å…¥/å¯¼å‡º</h3>
        <textarea id="io-textarea" placeholder="åœ¨æ­¤å¤„ç²˜è´´å†…å®¹..."></textarea>
        <!-- ä¿®æ”¹æŒ‰é’®åŒºåŸŸ -->
        <div class="modal-btns">
            <!-- å¤åˆ¶æŒ‰é’® (å¯¼å‡ºæ—¶æ˜¾ç¤º) -->
            <button class="btn secondary" id="copy-btn" onclick="copyToClipboard()">å¤åˆ¶</button>
            <!-- æ–°å¢ï¼šä¸‹è½½æŒ‰é’® (å¯¼å‡ºæ—¶æ˜¾ç¤º) -->
            <button class="btn secondary" id="download-btn" onclick="downloadJson()" style="display: none; background-color: #007aff; color: white;">ä¸‹è½½æ–‡ä»¶</button>
            <!-- æ–°å¢ï¼šåŒæ­¥æŒ‰é’® (å¯¼å…¥æ—¶æ˜¾ç¤º) -->
            <button class="btn secondary" id="sync-btn" onclick="syncFromGitee()" style="background-color: #34C759; color: white; display: none;">åŒæ­¥github</button>
            <!-- æ¸…ç©ºæŒ‰é’® (å¯¼å…¥æ—¶æ˜¾ç¤º) -->
            <button class="btn danger" id="clear-btn" onclick="clearTextarea()">æ¸…ç©º</button>
            <!-- å…³é—­æŒ‰é’® (å¸¸é©») -->
            <button class="btn secondary" onclick="closeModal()">å…³é—­</button>
            <!-- ç¡®è®¤æŒ‰é’® (å¯¼å…¥æ—¶æ˜¾ç¤º) -->
            <button class="btn" id="modal-action-btn" onclick="confirmImport()">ç¡®è®¤</button>
        </div>
    </div>
</div>

<script>
    // é»˜è®¤æ•°æ®
    let words = [
        { id: 1, text: "apple", pinyin: "è‹¹æœ", checked: true },
        { id: 2, text: "butterfly", pinyin: "è´è¶", checked: true },
        { id: 3, text: "delicious", pinyin: "ç¾å‘³çš„", checked: false }
    ];

    let editingIndex = -1;
    // æ–°å¢ï¼šè®°å½•åŒºé—´é€‰æ‹©çš„èµ·å§‹ç´¢å¼•
    let rangeStartIndex = -1;

    // --- IndexedDB åˆå§‹åŒ– (ç”¨äºå­˜å‚¨éŸ³é¢‘) ---
    let db;
    const DB_NAME = 'DictationAudioDB';
    const STORE_NAME = 'audios';

    function initDB() {
        return new Promise((resolve) => {
            const request = indexedDB.open(DB_NAME, 1);
            request.onerror = () => resolve(false);
            request.onupgradeneeded = (e) => {
                const d = e.target.result;
                if (!d.objectStoreNames.contains(STORE_NAME)) {
                    d.createObjectStore(STORE_NAME);
                }
            };
            request.onsuccess = (e) => {
                db = e.target.result;
                resolve(true);
            };
        });
    }

    // è¾…åŠ©ï¼šä»æ•°æ®åº“è·å–éŸ³é¢‘
    function getAudioBlob(text) {
        return new Promise((resolve) => {
            if (!db) return resolve(null);
            try {
                const tx = db.transaction(STORE_NAME, 'readonly');
                const store = tx.objectStore(STORE_NAME);
                const req = store.get(text);
                req.onsuccess = (e) => resolve(e.target.result);
                req.onerror = () => resolve(null);
            } catch(e) { resolve(null); }
        });
    }

    // è¾…åŠ©ï¼šä¿å­˜éŸ³é¢‘åˆ°æ•°æ®åº“
    function saveAudioBlob(text, blob) {
        if (!db) return;
        try {
            const tx = db.transaction(STORE_NAME, 'readwrite');
            const store = tx.objectStore(STORE_NAME);
            store.put(blob, text);
        } catch(e) { console.warn('Save audio failed', e); }
    }

    window.onload = async function() { // æ”¹ä¸º async
        await initDB(); // ç­‰å¾…æ•°æ®åº“åˆå§‹åŒ–
        const saved = localStorage.getItem('english_words');
        if (saved) { words = JSON.parse(saved); }
        renderList();
    };

    function save() {
        localStorage.setItem('english_words', JSON.stringify(words)); // Changed key
        renderList();
    }

    function renderList() {
        const listDom = document.getElementById('word-list-dom');
        listDom.innerHTML = '';
        
        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        const selectedCount = words.filter(w => w.checked).length;
        document.getElementById('word-stats').innerText = `å·²é€‰ ${selectedCount} / å…± ${words.length}`;

        words.forEach((item, index) => {
            const li = document.createElement('li');
            li.className = 'word-item';
            
            // è½¬ä¹‰è‹±æ–‡ä¸­çš„å•å¼•å·ï¼Œé˜²æ­¢ç ´å onclick è¯­æ³•
            const safeText = item.text.replace(/'/g, "\\'");

            // ä¿®æ”¹ï¼šHTMLç»“æ„è°ƒæ•´ï¼Œçªå‡ºè‹±æ–‡æ˜¾ç¤º
            li.innerHTML = `
                <div class="word-item-top">
                    <!-- å·¦ä¾§é€‰æ¡†ç»„ -->
                    <div class="checkbox-wrapper" onclick="toggleRange(${index})" title="ç‚¹å‡»ä¸¤ä¸ªæ–¹æ¡†ä»¥é€‰ä¸­ä¸­é—´æ‰€æœ‰è¯">
                        <div class="range-checkbox ${rangeStartIndex === index ? 'active' : ''}"></div>
                    </div>
                    <div class="checkbox-wrapper" onclick="toggleCheck(${index})">
                        <div class="custom-checkbox ${item.checked ? 'checked' : ''}"></div>
                    </div>
                    
                    <!-- ä¸­é—´å†…å®¹ï¼šä¸Šè‹±æ–‡ï¼Œä¸‹ä¸­æ–‡ -->
                    <div class="word-content" onclick="toggleCheck(${index})">
                        <div class="word-pinyin" style="font-weight:600; font-size:18px; color:#000;">${item.text}</div>
                        <div class="word-text" style="font-size:14px; color:#666;">${item.pinyin}</div>
                    </div>
                    
                    <!-- å³ä¾§æŒ‰é’®ï¼šçºµå‘å †å  -->
                    <div class="action-btns">
                        <!-- æ–°å¢ï¼šæ’­æ”¾æŒ‰é’® -->
                         <div class="icon-btn" style="background:#e3f2fd; color:#007aff;" onclick="speak('${safeText}')">æ’­æ”¾</div>
                        <div class="icon-btn" onclick="editWord(${index})">ç¼–è¾‘</div>
                        <div class="icon-btn" style="color:var(--danger-color); background:#fff0f0;" onclick="deleteWord(${index})">åˆ é™¤</div>
                    </div>
                </div>
                ${item.lastTested ? `<div class="last-tested">ä¸Šæ¬¡æµ‹è¯•: ${formatDate(item.lastTested)}</div>` : ''}
            `;
            listDom.appendChild(li);
        });
    }

    // --- æ–°å¢ï¼šè‡ªåŠ¨ç¿»è¯‘åŠŸèƒ½ ---
    async function autoTranslate() {
        const wordInput = document.getElementById('new-word');
        const pinyinInput = document.getElementById('new-pinyin');
        const word = wordInput.value.trim();
        
        if(!word) return alert("è¯·å…ˆè¾“å…¥è‹±è¯­å•è¯");

        const originalVal = pinyinInput.value;
        pinyinInput.value = "ç¿»è¯‘ä¸­...";
        pinyinInput.disabled = true;

        try {
            // ä½¿ç”¨ MyMemory API
            const res = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(word)}&langpair=en|zh`);
            const data = await res.json();
            if (data && data.responseData && data.responseData.translatedText) {
                pinyinInput.value = data.responseData.translatedText;
            } else {
                pinyinInput.value = originalVal;
                alert("ç¿»è¯‘å¤±è´¥ï¼Œè¯·é‡è¯•æˆ–æ‰‹åŠ¨è¾“å…¥");
            }
        } catch(e) {
            console.error("Translation failed", e);
            pinyinInput.value = originalVal;
            alert("ç¿»è¯‘æœåŠ¡è¿æ¥å¤±è´¥");
        } finally {
            pinyinInput.disabled = false;
            pinyinInput.focus();
        }
    }

    // --- ç§»é™¤ autoGeneratePinyin å‡½æ•° ---
    function autoGeneratePinyin() { /* è‹±è¯­æ¨¡å¼ä¸‹ä¸éœ€è¦æ­¤åŠŸèƒ½ */ }

    // --- åŠŸèƒ½åŒº ---
    function handleWordSubmit() {
        const w = document.getElementById('new-word').value.trim();
        const p = document.getElementById('new-pinyin').value.trim();
        
        if(!w) return alert('è¯·è¾“å…¥å•è¯');

        if (editingIndex === -1) {
            // textå­˜è‹±æ–‡, pinyinå­˜ä¸­æ–‡æ„æ€
            words.push({ id: Date.now(), text: w, pinyin: p || ' ', checked: true });
            // æ–°å¢ï¼šæ·»åŠ å•è¯æ—¶è‡ªåŠ¨æœ—è¯»å¹¶å°è¯•ç¼“å­˜
            // æ³¨æ„ï¼šå¦‚æœé‡åˆ°è·¨åŸŸé™åˆ¶(CORS)æ— æ³•ä¸‹è½½æ–‡ä»¶ï¼Œä»£ç ä¼šè‡ªåŠ¨é™çº§ä¸ºç›´æ¥æ’­æ”¾URL
            speak(w);
        } else {
            words[editingIndex].text = w;
            words[editingIndex].pinyin = p;
            cancelEdit();
        }
        
        document.getElementById('new-word').value = '';
        document.getElementById('new-pinyin').value = '';
        save();
    }

    function editWord(index) {
        editingIndex = index;
        const item = words[index];
        document.getElementById('new-word').value = item.text;
        document.getElementById('new-pinyin').value = item.pinyin;
        document.getElementById('submit-btn').innerText = "ä¿å­˜";
        document.getElementById('cancel-btn').style.display = "inline-block";
        document.getElementById('new-word').focus();
        window.scrollTo(0,0);
    }

    function cancelEdit() {
        editingIndex = -1;
        document.getElementById('new-word').value = '';
        document.getElementById('new-pinyin').value = '';
        document.getElementById('submit-btn').innerText = "æ·»åŠ ";
        document.getElementById('cancel-btn').style.display = "none";
    }

    function deleteWord(index) {
        if(editingIndex === index) {
            return alert("è¯·å…ˆå–æ¶ˆç¼–è¾‘");
        }
        if(confirm('ç¡®å®šåˆ é™¤?')) {
            words.splice(index, 1);
            if(editingIndex > index) editingIndex--; 
            save();
        }
    }

    // --- æ–°å¢: æ‰¹é‡åˆ é™¤åŠŸèƒ½ ---
    function deleteSelected() {
        const count = words.filter(w => w.checked).length;
        if(count === 0) return alert('è¯·å…ˆå‹¾é€‰è¦åˆ é™¤çš„è¯è¯­');
        
        if(confirm(`ç¡®å®šåˆ é™¤é€‰ä¸­çš„ ${count} ä¸ªè¯è¯­å—ï¼Ÿ`)) {
            if(editingIndex !== -1) cancelEdit(); // å¦‚æœæ­£åœ¨ç¼–è¾‘ï¼Œå…ˆé€€å‡ºç¼–è¾‘æ¨¡å¼
            words = words.filter(w => !w.checked);
            rangeStartIndex = -1; // é‡ç½®åŒºé—´é€‰æ‹©
            save();
        }
    }

    function toggleCheck(index) {
        words[index].checked = !words[index].checked;
        save();
    }

    // æ–°å¢ï¼šå¤„ç†åŒºé—´é€‰æ‹©é€»è¾‘
    function toggleRange(index) {
        // å¦‚æœè¿˜æ²¡æœ‰é€‰æ‹©èµ·ç‚¹ï¼Œæˆ–è€…ç‚¹å‡»çš„æ˜¯å½“å‰çš„èµ·ç‚¹ï¼ˆå–æ¶ˆèµ·ç‚¹ï¼‰
        if (rangeStartIndex === -1) {
            rangeStartIndex = index;
            renderList(); // é‡æ–°æ¸²æŸ“ä»¥æ˜¾ç¤ºæ¿€æ´»çŠ¶æ€
        } else if (rangeStartIndex === index) {
            rangeStartIndex = -1; // å–æ¶ˆé€‰æ‹©
            renderList();
        } else {
            // å·²æœ‰èµ·ç‚¹ï¼Œä¸”ç‚¹å‡»äº†ä¸åŒçš„ç‚¹ -> æ‰§è¡Œæ‰¹é‡é€‰ä¸­
            const start = Math.min(rangeStartIndex, index);
            const end = Math.max(rangeStartIndex, index);
            
            // æ£€æŸ¥èŒƒå›´å†…æ˜¯å¦æœ‰æœªé€‰ä¸­çš„
            let hasUnchecked = false;
            for (let i = start; i <= end; i++) {
                if (!words[i].checked) {
                    hasUnchecked = true;
                    break;
                }
            }

            // é€»è¾‘: å¦‚æœèŒƒå›´å†…çš„è¯è¯­æœ‰ä¸€ä¸ªæ²¡æœ‰è¢«é€‰æ‹©(hasUncheckedä¸ºtrue)å°±å…¨éƒ¨é€‰ä¸­(target=true). 
            // å¦åˆ™(è¯´æ˜éƒ½è¢«é€‰ä¸­äº†)å°±æŠŠæ‰€æœ‰è¯è¯­å–æ¶ˆé€‰æ‹©(target=false)
            const targetState = hasUnchecked;

            // åº”ç”¨çŠ¶æ€
            for (let i = start; i <= end; i++) {
                words[i].checked = targetState;
            }
            
            rangeStartIndex = -1; // åŠ¨ä½œå®Œæˆï¼Œé‡ç½®
            save(); // ä¿å­˜å¹¶é‡æ–°æ¸²æŸ“
        }
    }

    function selectAll() {
        const allChecked = words.every(w => w.checked);
        words.forEach(w => w.checked = !allChecked);
        save();
    }
    
    function clearWords() {
        if(confirm('ç¡®å®šæ¸…ç©ºæ‰€æœ‰è¯è¯­å—ï¼Ÿ')) {
            words = [];
            save();
        }
    }

    // æ–°å¢ï¼šæŒ‰æ—¶é—´æ’åºåŠŸèƒ½
    let sortAsc = true; // æ’åºçŠ¶æ€æ ‡è®°
    function sortByTime() {
        // æ’åºä¼šæ‰“ä¹±ç´¢å¼•ï¼Œå› æ­¤å…ˆå–æ¶ˆç¼–è¾‘å’ŒåŒºé—´é€‰æ‹©
        if(editingIndex !== -1) cancelEdit();
        rangeStartIndex = -1;

        words.sort((a, b) => {
            const t1 = a.lastTested || 0;
            const t2 = b.lastTested || 0;
            // å‡åºï¼šæœªæµ‹è¯•(0)åœ¨å‰ï¼›é™åºï¼šæœ€è¿‘æµ‹è¯•(å¤§æ—¶é—´æˆ³)åœ¨å‰
            return sortAsc ? (t1 - t2) : (t2 - t1);
        });
        
        sortAsc = !sortAsc; // åˆ‡æ¢ä¸‹æ¬¡æ’åºé¡ºåº
        save(); // ä¿å­˜é¡ºåºå¹¶é‡æ–°æ¸²æŸ“
    }

    // --- æ–°å¢: å¤åˆ¶æ–‡æœ¬ ---
    function copyToClipboard() {
        const textarea = document.getElementById('io-textarea');
        textarea.select();
        textarea.setSelectionRange(0, 99999); // é€‚é…ç§»åŠ¨ç«¯
        
        // å°è¯•ä½¿ç”¨ Clipboard APIï¼Œå¦‚æœä¸æ”¯æŒåˆ™å›é€€
        if (navigator.clipboard && window.isSecureContext) {
            navigator.clipboard.writeText(textarea.value).then(() => {
                alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            }).catch(() => {
                document.execCommand('copy'); // å›é€€æ–¹æ¡ˆ
                alert('å·²å¤åˆ¶');
            });
        } else {
            document.execCommand('copy'); // å›é€€æ–¹æ¡ˆ
            alert('å·²å¤åˆ¶');
        }
    }

    // --- æ–°å¢: æ¸…ç©ºæ–‡æœ¬ ---
    function clearTextarea() {
        const textarea = document.getElementById('io-textarea');
        textarea.value = '';
        textarea.focus();
    }

    // æ–°å¢ï¼šä¸‹è½½ JSON æ–‡ä»¶
    function downloadJson() {
        const content = document.getElementById('io-textarea').value;
        if (!content) return;

        const d = new Date();
        const dateStr = `${d.getFullYear()}-${(d.getMonth()+1).toString().padStart(2,'0')}-${d.getDate().toString().padStart(2,'0')}`;
        const fileName = `${dateStr}-è‹±æ–‡è¯è¯­.json`;

        const blob = new Blob([content], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    // æ–°å¢ï¼šä» github åŒæ­¥ JSON
    function syncFromGitee() {
        const url = 'https://raw.githubusercontent.com/fly-redis/learn/refs/heads/main/%E4%B8%89%E5%B9%B4%E7%BA%A7%E4%B8%8A%E5%AD%A6%E6%9C%9F%E8%8B%B1%E8%AF%AD.json';
        const textarea = document.getElementById('io-textarea');
        
        textarea.value = 'æ­£åœ¨ä» github è·å–æ•°æ®...';
        
        fetch(url)
            .then(response => {
                if (!response.ok) throw new Error('ç½‘ç»œè¯·æ±‚å¤±è´¥');
                return response.text();
            })
            .then(text => {
                textarea.value = text;
                alert('è·å–æˆåŠŸï¼è¯·æ£€æŸ¥å†…å®¹å¹¶ç‚¹å‡»"ç¡®è®¤"å®Œæˆå¯¼å…¥ã€‚');
            })
            .catch(err => {
                textarea.value = '';
                alert('åŒæ­¥å¤±è´¥: ' + err.message);
            });
    }

    function openModal(title, content, isImport) {
        const modal = document.getElementById('io-modal');
        modal.style.display = 'flex'; 
        
        document.getElementById('modal-title').innerText = title;
        document.getElementById('io-textarea').value = content;
        
        // è·å–æŒ‰é’®DOM
        const actionBtn = document.getElementById('modal-action-btn');
        const copyBtn = document.getElementById('copy-btn');
        const downloadBtn = document.getElementById('download-btn'); // æ–°å¢
        const clearBtn = document.getElementById('clear-btn');
        const syncBtn = document.getElementById('sync-btn'); // æ–°å¢
        const textarea = document.getElementById('io-textarea');

        if(isImport) {
            // å¯¼å…¥æ¨¡å¼: æ˜¾ç¤ºç¡®è®¤ã€æ¸…ç©ºã€åŒæ­¥ï¼›éšè—å¤åˆ¶
            actionBtn.style.display = 'block';
            clearBtn.style.display = 'block';
            syncBtn.style.display = 'block'; // æ˜¾ç¤ºåŒæ­¥æŒ‰é’®
            copyBtn.style.display = 'none';
            downloadBtn.style.display = 'none'; // éšè—ä¸‹è½½
            textarea.readOnly = false;
        } else {
            // å¯¼å‡ºæ¨¡å¼: æ˜¾ç¤ºå¤åˆ¶ï¼›éšè—ç¡®è®¤ã€æ¸…ç©ºã€åŒæ­¥
            actionBtn.style.display = 'none';
            clearBtn.style.display = 'none';
            syncBtn.style.display = 'none'; // éšè—åŒæ­¥æŒ‰é’®
            copyBtn.style.display = 'block';
            downloadBtn.style.display = 'block'; // æ˜¾ç¤ºä¸‹è½½
            textarea.readOnly = true;
            textarea.select();
        }
    }
    
    function closeModal() { document.getElementById('io-modal').style.display = 'none'; }
    
    function exportJson() {
        // ä¿®æ”¹ï¼šå¯¼å‡ºç»“æ„è°ƒæ•´ä¸º english (è‹±æ–‡) å’Œ chinese (ä¸­æ–‡)ï¼Œä¿ç•™ lastTested
        const exportData = words.map(w => ({ 
            english: w.text, 
            chinese: w.pinyin, 
            lastTested: w.lastTested 
        }));
        openModal('å¯¼å‡ºå†…å®¹', JSON.stringify(exportData, null, 2), false);
    }
    
    function importJson() { openModal('ç²˜è´´JSON', '', true); }

    function confirmImport() {
        try {
            const raw = document.getElementById('io-textarea').value;
            const data = JSON.parse(raw);
            if(!Array.isArray(data)) throw new Error();
            const newWords = data.map(i => ({
                id: Date.now() + Math.random(),
                // å…¼å®¹ english/chinese ä»¥åŠæ—§çš„ word/text/pinyin
                text: i.english || i.word || i.text, 
                pinyin: i.chinese || i.pinyin || '',
                checked: true,
                lastTested: i.lastTested || null // ä¿®æ”¹ï¼šå¯¼å…¥æ—¶ä¿ç•™æµ‹è¯•æ—¶é—´
            })).filter(i => i.text);
            
            if(confirm('è¦†ç›–å½“å‰åˆ—è¡¨? å–æ¶ˆåˆ™è¿½åŠ ã€‚')) words = newWords;
            else words = words.concat(newWords);
            
            save();
            closeModal();
        } catch(e) { alert('JSONæ ¼å¼é”™è¯¯'); }
    }
    
    // æ–°å¢ï¼šæ ¼å¼åŒ–æ—¶é—´æˆ³
    function formatDate(timestamp) {
        if (!timestamp) return '';
        const d = new Date(timestamp);
        const y = d.getFullYear();
        const m = (d.getMonth() + 1);
        const day = d.getDate();
        const h = d.getHours().toString().padStart(2, '0');
        const min = d.getMinutes().toString().padStart(2, '0');
        const s = d.getSeconds().toString().padStart(2, '0');
        return `${y}å¹´${m}æœˆ${day}æ—¥ ${h}:${min}:${s}`;
    }


    // --- å¬å†™åŠŸèƒ½ ---
    function startDictation(mode) {
        // mode: 'dictation' (çœ‹ä¸­æ–‡å†™è‹±æ–‡) æˆ– 'show_english' (çœ‹è‹±æ–‡)
        const currentMode = mode || 'dictation';
        
        const selected = words.filter(w => w.checked);
        if(selected.length === 0) return alert('è¯·å…ˆå‹¾é€‰');

        // æ–°å¢ï¼šä¿å­˜åˆ°å†å²è®°å½•
        addToHistory(selected);

        // æ–°å¢ï¼šæ›´æ–°é€‰ä¸­è¯è¯­çš„æµ‹è¯•æ—¶é—´
        const now = Date.now();
        words.forEach(w => {
            if (w.checked) {
                w.lastTested = now;
            }
        });
        save();
        renderList(); 

        const container = document.getElementById('dictation-area');
        container.innerHTML = '';
        
        // è®¾ç½®æ ‡é¢˜
        document.getElementById('header-title').innerText = currentMode === 'show_english' ? "è‹±æ–‡å±•ç¤º" : "å•è¯é»˜å†™";
        
        const shuffled = [...selected].sort(() => Math.random() - 0.5);

        shuffled.forEach(item => {
            const card = document.createElement('div');
            card.className = `dictation-card`; // ç§»é™¤æ—§çš„ mode ç±»ï¼Œä½¿ç”¨ç»Ÿä¸€é€»è¾‘
            
            // æ¨¡å¼åˆ¤æ–­
            const isDictation = currentMode === 'dictation';
            // æ˜¾ç¤ºå†…å®¹ï¼šé»˜å†™æ¨¡å¼æ˜¾ç¤ºä¸­æ–‡(item.pinyin)ï¼Œå±•ç¤ºæ¨¡å¼æ˜¾ç¤ºè‹±æ–‡(item.text)
            const displayPrimary = isDictation ? item.pinyin : item.text;
            // ç­”æ¡ˆå†…å®¹ï¼šé»˜å†™æ¨¡å¼æ˜¾ç¤ºè‹±æ–‡ï¼Œå±•ç¤ºæ¨¡å¼æ˜¾ç¤ºä¸­æ–‡
            const displaySecondary = isDictation ? item.text : item.pinyin;
            
            // è‹±æ–‡å•è¯æ— è®ºæ˜¯é¢˜ç›®è¿˜æ˜¯ç­”æ¡ˆï¼Œå¦‚æœæ˜¯è‹±æ–‡åˆ™éœ€è¦è½¬ä¹‰å•å¼•å·ä»¥ä¾›speakä½¿ç”¨
            const englishWord = item.text.replace(/'/g, "\\'");

            card.onclick = function() { this.classList.toggle('revealed'); };
            
            card.innerHTML = `
                <div class="q-text">${displayPrimary || '(æ— ä¹‰)'}</div>
                
                <div style="margin: 10px 0;">
                     <button class="btn secondary" style="padding: 6px 16px; font-size: 14px; border-radius: 20px;" 
                        onclick="event.stopPropagation(); speak('${englishWord}')">
                        ğŸ”Š æ’­æ”¾
                    </button>
                </div>

                <div class="a-text">${displaySecondary}</div>
                
                <div class="hint">ç‚¹å‡»æ˜¾ç¤ºç­”æ¡ˆ</div>
            `;
            container.appendChild(card);
        });

        document.getElementById('main-page').style.display = 'none';
        document.getElementById('dictation-page').style.display = 'block';
        window.scrollTo(0,0);
    }

    function exitDictation() {
        document.getElementById('dictation-page').style.display = 'none';
        document.getElementById('main-page').style.display = 'block';
        document.getElementById('header-title').innerText = "å•è¯æœ¬";
    }

    function toggleAllAnswers() {
        const cards = document.querySelectorAll('.dictation-card');
        const anyHidden = Array.from(cards).some(c => !c.classList.contains('revealed'));
        cards.forEach(c => {
            if(anyHidden) c.classList.add('revealed');
            else c.classList.remove('revealed');
        });
    }

    // --- æ–°å¢ï¼šå†å²è®°å½•ç›¸å…³é€»è¾‘ ---
    
    function addToHistory(selectedWords) {
        let history = JSON.parse(localStorage.getItem('english_dictation_history') || '[]'); // Changed key
        const record = {
            timestamp: Date.now(),
            wordTexts: selectedWords.map(w => w.text) // åªå­˜æ–‡æœ¬ï¼Œæ–¹ä¾¿æ£€ç´¢
        };
        // åŠ åˆ°æœ€å‰é¢
        history.unshift(record);
        // åªä¿ç•™æœ€è¿‘5æ¡
        if (history.length > 5) {
            history = history.slice(0, 5);
        }
        localStorage.setItem('english_dictation_history', JSON.stringify(history)); // Changed key
    }

    function showHistory() {
        const history = JSON.parse(localStorage.getItem('english_dictation_history') || '[]'); // Changed key
        const listDom = document.getElementById('history-list');
        listDom.innerHTML = '';
        
        if (history.length === 0) {
            listDom.innerHTML = '<div style="text-align:center; color:#999; padding:20px;">æš‚æ— å†å²è®°å½•</div>';
        } else {
            history.forEach((rec, idx) => {
                const li = document.createElement('li');
                li.className = 'history-record';
                li.innerHTML = `
                    <div class="history-header">
                        <div class="history-time">
                            ${formatDate(rec.timestamp)}
                            <br><span style="font-size:12px;color:#999">è¯æ•°: ${rec.wordTexts.length}</span>
                        </div>
                        <div class="history-actions">
                            <button class="icon-btn" onclick="toggleHistoryDetail(this)">è¯¦æƒ…</button>
                            <button class="icon-btn" style="background:#e3f2fd; color:#007aff;" onclick="restoreHistory(${idx})">é‡æµ‹</button>
                        </div>
                    </div>
                    <div class="history-details">
                        ${rec.wordTexts.map(t => `<span class="history-tag">${t}</span>`).join('')}
                    </div>
                `;
                listDom.appendChild(li);
            });
        }
        document.getElementById('history-modal').style.display = 'flex';
    }

    function closeHistoryModal() {
        document.getElementById('history-modal').style.display = 'none';
    }

    function toggleHistoryDetail(btn) {
        const details = btn.parentElement.parentElement.nextElementSibling;
        if (details.style.display === 'flex') {
            details.style.display = 'none';
            btn.innerText = 'è¯¦æƒ…';
        } else {
            details.style.display = 'flex';
            btn.innerText = 'æ”¶èµ·';
        }
    }

    function restoreHistory(idx) {
        const history = JSON.parse(localStorage.getItem('english_dictation_history') || '[]'); // Changed key
        const rec = history[idx];
        if (!rec) return;
        
        // 1. æ¸…ç©ºå½“å‰æ‰€æœ‰é€‰æ‹©
        words.forEach(w => w.checked = false);
        
        const missing = [];
        let count = 0;
        
        // 2. éå†è®°å½•ä¸­çš„è¯ï¼Œåœ¨ç°æœ‰åˆ—è¡¨ä¸­æŸ¥æ‰¾å¹¶é€‰ä¸­
        rec.wordTexts.forEach(txt => {
            const found = words.find(w => w.text === txt);
            if (found) {
                found.checked = true;
                count++;
            } else {
                missing.push(txt);
            }
        });
        
        // 3. ä¿å­˜çŠ¶æ€å¹¶æ›´æ–°ç•Œé¢
        save();     // ä¿å­˜é€‰ä¸­çŠ¶æ€
        renderList(); // é‡ç»˜ä¸»åˆ—è¡¨
        closeHistoryModal(); // å…³é—­å¼¹çª—
        
        // 4. æç¤ºç»“æœ
        let msg = `å·²é€‰ä¸­å†å²è®°å½•ä¸­çš„ ${count} ä¸ªè¯è¯­ã€‚`;
        if (missing.length > 0) {
            msg += `\n\næ³¨æ„ï¼šä»¥ä¸‹ ${missing.length} ä¸ªè¯è¯­åœ¨å½“å‰åˆ—è¡¨ä¸­æœªæ‰¾åˆ°ï¼ˆå¯èƒ½å·²è¢«åˆ é™¤ï¼‰ï¼š\n${missing.join(', ')}`;
        }
        alert(msg);
    }

    function exitDictation() {
        document.getElementById('dictation-page').style.display = 'none';
        document.getElementById('main-page').style.display = 'block';
        document.getElementById('header-title').innerText = "å•è¯æœ¬";
    }

    // --- æ–°å¢ï¼šæ»šåŠ¨å›é¡¶éƒ¨é€»è¾‘ ---
    window.onscroll = function() {
        const btn = document.getElementById('back-to-top');
        // æ»šåŠ¨è¶…è¿‡300pxæ˜¾ç¤ºæŒ‰é’®
        if (document.body.scrollTop > 300 || document.documentElement.scrollTop > 300) {
            btn.style.display = 'flex';
        } else {
            btn.style.display = 'none';
        }
    };

    function scrollToTop() {
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // --- æ–°å¢ï¼šæ‰¹é‡ç¼“å­˜éŸ³é¢‘ ---
    async function cacheAllAudio() {
        const total = words.length;
        if (total === 0) return alert('åˆ—è¡¨ä¸ºç©º');
        if (!confirm(`ç¡®å®šè¦å°è¯•ç¼“å­˜ ${total} ä¸ªå•è¯çš„éŸ³é¢‘å—ï¼Ÿ\nè¿™å°†é€ä¸ªè¯·æ±‚ç™¾åº¦è¯­éŸ³æ¥å£å¹¶ä¿å­˜åˆ°æœ¬åœ°ã€‚\næ³¨æ„ï¼šå—è·¨åŸŸ(CORS)é™åˆ¶ï¼Œæ™®é€šç½‘é¡µç¯å¢ƒå¯èƒ½ä¼šå¤±è´¥ã€‚`)) return;

        const stats = document.getElementById('word-stats');
        const originalText = stats.innerText;
        let cached = 0;
        let skipped = 0;
        let failed = 0;

        for (let i = 0; i < total; i++) {
            const word = words[i].text;
            stats.innerText = `ç¼“å­˜ä¸­ ${i+1}/${total}...`;
            
            try {
                // 1. æ£€æŸ¥æ˜¯å¦å­˜åœ¨
                const exists = await getAudioBlob(word);
                if (exists) {
                    skipped++;
                    continue;
                }

                // 2. ä¸‹è½½
                const url = `https://fanyi.baidu.com/gettts?lan=en&text=${encodeURIComponent(word)}&spd=3&source=web`;
                const resp = await fetch(url);
                if (resp.ok) {
                    const blob = await resp.blob();
                    saveAudioBlob(word, blob);
                    cached++;
                    // å»¶æ—¶é¿å…è¯·æ±‚è¿‡å¿«è¢«å°
                    await new Promise(r => setTimeout(r, 500));
                } else {
                    failed++;
                }
            } catch (e) {
                console.warn(`Cache failed for ${word}`, e);
                failed++;
            }
        }
        
        stats.innerText = originalText;
        alert(`ä»»åŠ¡ç»“æŸ\næ–°å¢ç¼“å­˜: ${cached}\nå·²å­˜åœ¨: ${skipped}\nå¤±è´¥: ${failed}\nå¦‚æœå¤±è´¥è¾ƒå¤šï¼Œé€šå¸¸æ˜¯å› ä¸ºæµè§ˆå™¨å®‰å…¨ç­–ç•¥é™åˆ¶äº†è·¨åŸŸä¸‹è½½ã€‚`);
    }

    // ä¿®æ”¹ï¼šæ–‡æœ¬æœ—è¯»åŠŸèƒ½ (ä¼˜å…ˆä½¿ç”¨æœ¬åœ°ç¼“å­˜ -> ç™¾åº¦TTS -> æµè§ˆå™¨åŸç”Ÿ)
    async function speak(text) {
        const url = `https://fanyi.baidu.com/gettts?lan=en&text=${encodeURIComponent(text)}&spd=3&source=web`;

        // 1. å°è¯•ä» IndexedDB æœ¬åœ°è¯»å–
        try {
            const blob = await getAudioBlob(text);
            if (blob) {
                console.log('Playing from local cache:', text);
                const audio = new Audio(URL.createObjectURL(blob));
                audio.play().catch(e => useBrowserTTS(text));
                return;
            }
        } catch(e) { console.warn('DB read error', e); }

        // 2. å°è¯• Fetch ä¸‹è½½å¹¶ç¼“å­˜ (éœ€è¦æµè§ˆå™¨ç¯å¢ƒæ”¯æŒè·¨åŸŸè¯·æ±‚ï¼Œæˆ–ä½¿ç”¨æ’ä»¶)
        try {
            const resp = await fetch(url);
            if (resp.ok) {
                const blob = await resp.blob();
                saveAudioBlob(text, blob); // å­˜å…¥ DB
                console.log('Downloaded and cached:', text);
                const audio = new Audio(URL.createObjectURL(blob));
                audio.play().catch(e => useBrowserTTS(text));
                return;
            }
        } catch(e) {
            // ç™¾åº¦æ¥å£é€šå¸¸æœ‰ CORS é™åˆ¶ï¼Œç›´æ¥ fetch åœ¨æ™®é€šç½‘é¡µä¸­å¯èƒ½ä¼šå¤±è´¥
            console.log("Fetch failed (CORS restricted?), falling back to direct URL stream");
        }

        // 3. é™çº§ï¼šç›´æ¥ URL æ’­æ”¾ (ä¸ç¼“å­˜ï¼Œåˆ©ç”¨ Audio æ ‡ç­¾çš„è·¨åŸŸèƒ½åŠ›)
        const audio = new Audio(url);
        audio.play().catch(e => {
            console.warn("Direct play failed, switching to Browser TTS", e);
            useBrowserTTS(text);
        });
    }

    function useBrowserTTS(text) {
        if (!window.speechSynthesis) return;
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text);
        u.lang = 'en-US'; 
        u.rate = 0.8; 
        window.speechSynthesis.speak(u);
    }
</script>

</body>
</html>
